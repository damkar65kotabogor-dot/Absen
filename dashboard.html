<!DOCTYPE html>
<html class="light" lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Dashboard Absensi PPPK</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,100..900;1,100..900&amp;display=swap"
    rel="stylesheet" />
  <!-- Material Symbols -->
  <link
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
    rel="stylesheet" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <!-- Tailwind Config -->
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#135bec", // Brand Blue from image
            "background-light": "#f6f6f8",
            "background-dark": "#101622",
          },
          fontFamily: {
            "display": ["Public Sans", "sans-serif"]
          },
          borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
        },
      },
    }
  </script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" async></script>
  <!-- Lucide (Optional, but keeping for compatibility if needed) -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }

    /* Custom scrollbar for webkit */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* Calendar Grid Specifics */
    .calendar-day {
      aspect-ratio: 1/1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 9999px;
      cursor: pointer;
      font-size: 0.875rem;
    }

    .calendar-day:hover {
      background-color: #f8fafc;
    }

    .dark .calendar-day:hover {
      background-color: #1e293b;
    }

    .calendar-day.active {
      background-color: #135bec;
      color: white;
    }

    .calendar-day.empty {
      background: transparent;
      cursor: default;
    }
  </style>
</head>

<body
  class="font-display bg-background-light dark:bg-background-dark text-slate-900 dark:text-white h-screen flex overflow-hidden">

  <!-- Sidebar Overlay -->
  <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-20 hidden lg:hidden" onclick="toggleSidebar()"></div>

  <!-- Sidebar -->
  <aside id="sidebar"
    class="w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col flex-shrink-0 transition-all duration-300 z-30 fixed lg:relative h-full -translate-x-full lg:translate-x-0">
    <!-- Logo Area -->
    <a href="dashboard.html"
      class="h-16 flex items-center gap-3 px-6 border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
      <div class="size-8 rounded-lg bg-primary flex items-center justify-center text-white">
        <span class="material-symbols-outlined text-xl">badge</span>
      </div>
      <div>
        <h1 class="text-base font-bold text-slate-900 dark:text-white leading-none">Absensi PPPK</h1>
        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Admin Panel</p>
      </div>
    </a>
    <!-- Navigation -->
    <div class="flex-1 overflow-y-auto py-4 px-3 flex flex-col gap-1">
      <p class="px-3 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 mt-2">Menu Utama</p>
      <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-primary/10 text-primary group transition-colors"
        href="dashboard.html">
        <span class="material-symbols-outlined text-[20px]">dashboard</span>
        <span class="text-sm font-medium">Dashboard</span>
      </a>

      <p class="px-3 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 mt-6">Kepegawaian</p>
      <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 group transition-colors"
        href="pegawai.html">
        <span class="material-symbols-outlined text-[20px]">group</span>
        <span class="text-sm font-medium">Data Pegawai</span>
      </a>

      <p class="px-3 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 mt-6">Kehadiran</p>
      <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 group transition-colors"
        href="absensi.html">
        <span class="material-symbols-outlined text-[20px]">schedule</span>
        <span class="text-sm font-medium">Absensi</span>
      </a>
      <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 group transition-colors"
        href="cuti.html">
        <span class="material-symbols-outlined text-[20px]">calendar_month</span>
        <span class="text-sm font-medium">Pengajuan Cuti</span>
      </a>

      <p class="px-3 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 mt-6">Sistem</p>
      <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 group transition-colors"
        href="setting.html">
        <span class="material-symbols-outlined text-[20px]">settings</span>
        <span class="text-sm font-medium">Pengaturan</span>
      </a>
      <a class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 group transition-colors"
        href="profil.html">
        <span class="material-symbols-outlined text-[20px]">account_circle</span>
        <span class="text-sm font-medium">Profil Admin</span>
      </a>
    </div>
    <!-- User Profile Footer -->
    <div class="p-4 border-t border-slate-100 dark:border-slate-800">
      <div class="flex items-center gap-3">
        <div class="size-10 rounded-full bg-slate-200 dark:bg-slate-700 bg-cover bg-center user-avatar"
          style="background-image: url('https://ui-avatars.com/api/?name=Admin&background=0D8ABC&color=fff');">
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium text-slate-900 dark:text-white truncate user-name">Admin</p>
          <p class="text-xs text-slate-500 dark:text-slate-400 truncate user-role">Administrator</p>
        </div>
        <button class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200" onclick="Auth.logout()">
          <span class="material-symbols-outlined text-[20px]">logout</span>
        </button>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 flex flex-col h-full relative overflow-hidden" id="adminDashboard">
    <!-- Header -->
    <header
      class="h-16 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-6 z-10">
      <div class="flex items-center gap-4">
        <button class="lg:hidden text-slate-500 hover:text-slate-700" onclick="toggleSidebar()">
          <span class="material-symbols-outlined">menu</span>
        </button>
        <h2 class="text-xl font-bold text-slate-800 dark:text-white tracking-tight">Dashboard</h2>
      </div>
      <div class="flex items-center gap-4">
        <!-- Search -->
        <div class="hidden md:flex items-center bg-slate-100 dark:bg-slate-800 rounded-lg px-3 py-2 w-64">
          <span class="material-symbols-outlined text-slate-400 text-[20px]">search</span>
          <input
            class="bg-transparent border-none outline-none text-sm ml-2 w-full text-slate-700 dark:text-slate-200 placeholder:text-slate-400 focus:ring-0"
            placeholder="Cari pegawai..." type="text" />
        </div>
        <!-- Actions -->
        <div class="flex items-center gap-2">
          <button class="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full relative">
            <span class="material-symbols-outlined text-[22px]">notifications</span>
            <span
              class="absolute top-2 right-2 size-2 bg-red-500 rounded-full border-2 border-white dark:border-slate-900"></span>
          </button>
          <button class="p-2 text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full">
            <span class="material-symbols-outlined text-[22px]">help</span>
          </button>
        </div>
      </div>
    </header>

    <!-- Scrollable Dashboard Content -->
    <div class="flex-1 overflow-y-auto p-4 md:p-8">
      <div class="max-w-7xl mx-auto space-y-6">
        <!-- Headline -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <h3 class="text-2xl font-bold text-slate-900 dark:text-white">Ringkasan Hari Ini</h3>
            <p class="text-slate-500 dark:text-slate-400 text-sm mt-1" id="currentDateFull">Memuat tanggal...</p>
          </div>
          <div class="flex gap-3">
            <button onclick="downloadReport()"
              class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors flex items-center gap-2">
              <span class="material-symbols-outlined text-[18px]">download</span>
              Unduh Laporan
            </button>
            <button onclick="addManualAbsensi()"
              class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-lg shadow-blue-500/30 flex items-center gap-2">
              <span class="material-symbols-outlined text-[18px]">add</span>
              Absensi Manual
            </button>
          </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <!-- Card 1: Total -->
          <div
            class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Total Pegawai</p>
                <h4 class="text-2xl font-bold text-slate-900 dark:text-white mt-2" id="statTotalPegawai">0</h4>
              </div>
              <div class="p-2 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-lg">
                <span class="material-symbols-outlined text-[24px]">groups</span>
              </div>
            </div>
            <div class="mt-4 flex items-center gap-1 text-sm">
              <span class="text-emerald-600 font-medium bg-emerald-50 dark:bg-emerald-900/30 px-1.5 rounded"
                id="statPegawaiChange">+0</span>
              <span class="text-slate-400">bulan ini</span>
            </div>
          </div>
          <!-- Card 2: Hadir -->
          <div
            class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Hadir Tepat Waktu</p>
                <h4 class="text-2xl font-bold text-slate-900 dark:text-white mt-2" id="statHadir">0</h4>
              </div>
              <div class="p-2 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-lg">
                <span class="material-symbols-outlined text-[24px]">check_circle</span>
              </div>
            </div>
            <div class="mt-4 flex items-center gap-1 text-sm">
              <span class="text-emerald-600 font-medium" id="statHadirPersen">0%</span>
              <span class="text-slate-400">dari total pegawai</span>
            </div>
          </div>
          <!-- Card 3: Terlambat -->
          <div
            class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Terlambat</p>
                <h4 class="text-2xl font-bold text-slate-900 dark:text-white mt-2" id="statTerlambat">0</h4>
              </div>
              <div class="p-2 bg-amber-50 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 rounded-lg">
                <span class="material-symbols-outlined text-[24px]">schedule</span>
              </div>
            </div>
            <div class="mt-4 flex items-center gap-1 text-sm">
              <span class="text-amber-600 font-medium bg-amber-50 dark:bg-amber-900/30 px-1.5 rounded"
                id="statTerlambatChange">+0</span>
              <span class="text-slate-400">dari kemarin</span>
            </div>
          </div>
          <!-- Card 4: Absen/Izin -->
          <div
            class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Absen / Izin</p>
                <h4 class="text-2xl font-bold text-slate-900 dark:text-white mt-2" id="statAbsen">0</h4>
              </div>
              <div class="p-2 bg-rose-50 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400 rounded-lg">
                <span class="material-symbols-outlined text-[24px]">cancel</span>
              </div>
            </div>
            <div class="mt-4 flex items-center gap-1 text-sm">
              <span class="text-slate-400">Tanpa Keterangan</span>
            </div>
          </div>
        </div>

        <!-- Middle Section: Chart & Calendar -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Chart Section -->
          <div
            class="lg:col-span-2 bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm p-6">
            <div class="flex items-center justify-between mb-6">
              <div>
                <h4 class="text-lg font-bold text-slate-900 dark:text-white">Tren Kehadiran</h4>
                <p class="text-sm text-slate-500 dark:text-slate-400" id="chartDateRange">Statistik mingguan</p>
              </div>
              <select
                class="bg-slate-50 dark:bg-slate-800 border-none text-sm text-slate-600 dark:text-slate-300 rounded-lg px-3 py-1.5 focus:ring-0 cursor-pointer">
                <option>Minggu Ini</option>
                <option>Bulan Ini</option>
              </select>
            </div>

            <div class="h-64">
              <canvas id="attendanceChart"></canvas>
            </div>
          </div>

          <!-- Mini Calendar -->
          <div
            class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm p-6 flex flex-col">
            <div class="flex items-center justify-between mb-4">
              <h4 class="text-lg font-bold text-slate-900 dark:text-white" id="calendarMonth">Oktober 2023</h4>
              <div class="flex gap-1">
                <button class="p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded" id="prevMonth">
                  <span class="material-symbols-outlined text-[20px] text-slate-500">chevron_left</span>
                </button>
                <button class="p-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded" id="nextMonth">
                  <span class="material-symbols-outlined text-[20px] text-slate-500">chevron_right</span>
                </button>
              </div>
            </div>
            <div class="grid grid-cols-7 text-center text-xs font-semibold text-slate-400 mb-2">
              <div>Mn</div>
              <div>Sn</div>
              <div>Sl</div>
              <div>Rb</div>
              <div>Km</div>
              <div>Jm</div>
              <div>Sb</div>
            </div>
            <div class="grid grid-cols-7 gap-1 text-center text-sm flex-1" id="miniCalendarGrid">
              <!-- Populated via JS -->
            </div>

            <div class="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700 flex gap-4 text-xs text-slate-500">
              <div class="flex items-center gap-1.5">
                <div class="size-2 rounded-full bg-primary"></div>
                <span>Hari ini</span>
              </div>
              <div class="flex items-center gap-1.5">
                <div class="size-2 rounded-full bg-rose-500"></div>
                <span>Libur</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Attendance Table -->
        <div
          class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
          <div class="p-6 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white">Riwayat Absensi Terkini</h3>
            <div class="flex gap-2">
              <button
                class="px-3 py-1.5 text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg transition-colors">
                Lihat Semua
              </button>
              <button
                class="px-3 py-1.5 text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 rounded-lg transition-colors flex items-center gap-1">
                <span class="material-symbols-outlined text-[16px]">filter_list</span>
                Filter
              </button>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
              <thead class="text-xs text-slate-500 dark:text-slate-400 uppercase bg-slate-50 dark:bg-slate-800/50">
                <tr>
                  <th class="px-6 py-3 font-semibold">Pegawai</th>
                  <th class="px-6 py-3 font-semibold">Waktu Masuk</th>
                  <th class="px-6 py-3 font-semibold">Status</th>
                  <th class="px-6 py-3 font-semibold">Lokasi</th>
                  <th class="px-6 py-3 font-semibold text-right">Aksi</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100 dark:divide-slate-800" id="recentAbsensi">
                <!-- Data loaded via JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Mobile Employee Dashboard Placeholder (Same as before, hidden) -->
  <main class="w-full h-full bg-slate-200 justify-center items-center" id="pegawaiDashboard" style="display: none;">
    <div class="p-8 text-center bg-white rounded-lg shadow">
      <h2 class="text-xl font-bold mb-4">Halaman Pegawai Mobile</h2>
      <p class="mb-4">Tampilan ini khusus untuk akses mobile pegawai.</p>
      <button class="bg-primary text-white px-4 py-2 rounded" onclick="Auth.logout()">Logout</button>
    </div>
  </main>

  <!-- Manual Attendance Modal (Copied from previous structure, adapted classes) -->
  <!-- Using standard Tailwind Modal structure -->
  <div id="manualAttendanceModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity" onclick="closeManualModal()"></div>
    <div
      class="bg-white dark:bg-slate-900 rounded-2xl shadow-xl w-full max-w-lg z-50 overflow-hidden transform transition-all">
      <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between">
        <h3 class="text-lg font-bold text-slate-900 dark:text-white modal-title">Absensi Manual</h3>
        <button onclick="closeManualModal()" class="text-slate-400 hover:text-slate-600">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <div class="p-6">
        <form id="manualAttendanceForm" class="space-y-4">
          <input type="hidden" id="editAbsensiId">

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Pegawai <span
                class="text-red-500">*</span></label>
            <select id="manualPegawai"
              class="w-full rounded-lg border-slate-200 dark:border-slate-700 dark:bg-slate-800 text-sm focus:ring-primary focus:border-primary">
              <option value="">Pilih Pegawai</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Tanggal <span
                class="text-red-500">*</span></label>
            <input type="date" id="manualTanggal"
              class="w-full rounded-lg border-slate-200 dark:border-slate-700 dark:bg-slate-800 text-sm focus:ring-primary focus:border-primary">
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Jam Masuk <span
                  class="text-red-500">*</span></label>
              <input type="time" id="manualJamMasuk"
                class="w-full rounded-lg border-slate-200 dark:border-slate-700 dark:bg-slate-800 text-sm focus:ring-primary focus:border-primary">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Jam Keluar</label>
              <input type="time" id="manualJamKeluar"
                class="w-full rounded-lg border-slate-200 dark:border-slate-700 dark:bg-slate-800 text-sm focus:ring-primary focus:border-primary">
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Status <span
                class="text-red-500">*</span></label>
            <select id="manualStatus"
              class="w-full rounded-lg border-slate-200 dark:border-slate-700 dark:bg-slate-800 text-sm focus:ring-primary focus:border-primary">
              <option value="tepat_waktu">Hadir (Tepat Waktu)</option>
              <option value="terlambat">Hadir (Terlambat)</option>
              <option value="izin">Izin</option>
              <option value="sakit">Sakit</option>
              <option value="alpha">Alpha</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Keterangan</label>
            <textarea id="manualKeterangan" rows="3"
              class="w-full rounded-lg border-slate-200 dark:border-slate-700 dark:bg-slate-800 text-sm focus:ring-primary focus:border-primary"
              placeholder="Opsional"></textarea>
          </div>
        </form>
      </div>
      <div class="px-6 py-4 bg-slate-50 dark:bg-slate-800/50 flex justify-end gap-3">
        <button onclick="closeManualModal()"
          class="px-4 py-2 bg-white border border-slate-200 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-50">Batal</button>
        <button onclick="submitManualAttendance()"
          class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-blue-700">Simpan</button>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="detailAbsensiModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm transition-opacity"
      onclick="App.closeModal('detailAbsensiModal')"></div>
    <div class="bg-white dark:bg-slate-900 rounded-2xl shadow-xl w-full max-w-md z-50 overflow-hidden">
      <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between">
        <h3 class="text-lg font-bold text-slate-900 dark:text-white">Detail Absensi</h3>
        <button onclick="App.closeModal('detailAbsensiModal')" class="text-slate-400 hover:text-slate-600">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <div class="p-6 space-y-4">
        <div class="grid grid-cols-2 gap-4 text-sm">
          <div>
            <p class="text-slate-500 dark:text-slate-400 text-xs uppercase font-bold tracking-wider mb-1">Pegawai</p>
            <p class="font-medium text-slate-900 dark:text-white" id="detNama">-</p>
          </div>
          <div>
            <p class="text-slate-500 dark:text-slate-400 text-xs uppercase font-bold tracking-wider mb-1">Tanggal</p>
            <p class="font-medium text-slate-900 dark:text-white" id="detTanggal">-</p>
          </div>
          <div>
            <p class="text-slate-500 dark:text-slate-400 text-xs uppercase font-bold tracking-wider mb-1">Jam Masuk</p>
            <p class="font-medium text-slate-900 dark:text-white" id="detJamMasuk">-</p>
          </div>
          <div>
            <p class="text-slate-500 dark:text-slate-400 text-xs uppercase font-bold tracking-wider mb-1">Jam Keluar</p>
            <p class="font-medium text-slate-900 dark:text-white" id="detJamKeluar">-</p>
          </div>
          <div class="col-span-2">
            <p class="text-slate-500 dark:text-slate-400 text-xs uppercase font-bold tracking-wider mb-1">Status</p>
            <p class="font-medium text-slate-900 dark:text-white" id="detStatus">-</p>
          </div>
          <div class="col-span-2">
            <p class="text-slate-500 dark:text-slate-400 text-xs uppercase font-bold tracking-wider mb-1">Lokasi</p>
            <div id="detLokasiSection">
              <div id="detMapLinkMasuk"></div>
            </div>
          </div>
          <div class="col-span-2">
            <p class="text-slate-500 dark:text-slate-400 text-xs uppercase font-bold tracking-wider mb-1">Foto</p>
            <div class="w-full aspect-video bg-slate-100 rounded-lg overflow-hidden border border-slate-200">
              <img id="detFoto" src="" class="w-full h-full object-cover">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-client.js"></script>
  <script src="js/data.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/app.js"></script>

  <script>
    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await App.init();
      await loadDashboard();
    });

    // Sidebar Toggle Logic
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');

      // Toggle Translate class
      sidebar.classList.toggle('-translate-x-full');

      // Toggle Overlay
      overlay.classList.toggle('hidden');
    }

    // Modal Logic
    function closeManualModal() {
      const modal = document.getElementById('manualAttendanceModal');
      modal.classList.add('hidden');
    }

    async function addManualAbsensi() {
      // Reset form
      document.getElementById('manualAttendanceForm').reset();
      document.getElementById('editAbsensiId').value = '';
      document.getElementById('manualTanggal').value = new Date().toISOString().split('T')[0];

      // Pop Pegawai
      const pegawai = (await Data.getPegawai()).filter(p => p.status === 'aktif');
      const select = document.getElementById('manualPegawai');
      select.innerHTML = '<option value="">Pilih Pegawai</option>' +
        pegawai.map(p => `<option value="${p.id}">${p.nama}</option>`).join('');

      document.querySelector('#manualAttendanceModal .modal-title').textContent = 'Absensi Manual';
      document.getElementById('manualAttendanceModal').classList.remove('hidden');
    }

    async function submitManualAttendance() {
      const id = document.getElementById('editAbsensiId').value;
      const pegawaiId = document.getElementById('manualPegawai').value;
      const tanggal = document.getElementById('manualTanggal').value;
      const jamMasuk = document.getElementById('manualJamMasuk').value;
      const jamKeluar = document.getElementById('manualJamKeluar').value;
      const status = document.getElementById('manualStatus').value;
      const keterangan = document.getElementById('manualKeterangan').value;

      if (!pegawaiId || !tanggal || !jamMasuk) {
        alert('Mohon lengkapi data yang wajib diisi');
        return;
      }

      const data = {
        pegawai_id: pegawaiId,
        tanggal,
        jam_masuk: jamMasuk,
        jam_keluar: jamKeluar || null,
        status,
        keterangan: keterangan || null
      };

      try {
        if (id) {
          await Data.update('absensi', id, data);
        } else {
          await Data.create('absensi', data);
        }
        closeManualModal();
        loadDashboard(); // Refresh
      } catch (e) {
        console.error(e);
        alert('Gagal menyimpan');
      }
    }

    // Main Dashboard Logic
    let attendanceChart = null;
    let currentCalendarDate = new Date();

    async function loadDashboard() {
      try {
        await Data.isReady();
        const user = Auth.getCurrentUser();

        // Check Role
        if (user?.role === 'pegawai') {
          document.getElementById('adminDashboard').style.display = 'none';
          document.getElementById('sidebar').style.display = 'none';
          document.getElementById('pegawaiDashboard').style.display = 'flex';
          return;
        }

        // Update Date
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const dateEl = document.getElementById('currentDateFull');
        if (dateEl) dateEl.textContent = new Date().toLocaleDateString('id-ID', options);

        // Update Stats (Wrap in try-catch)
        try {
          const stats = await Data.getStats();
          document.getElementById('statTotalPegawai').textContent = stats.totalPegawai;
          document.getElementById('statHadir').textContent = stats.hadirHariIni || 0;
          document.getElementById('statTerlambat').textContent = stats.terlambatHariIni || 0;
          document.getElementById('statAbsen').textContent = stats.tidakHadir || 0;
        } catch (statErr) {
          console.warn("Stats error", statErr);
        }

        // Render Chart & Calendar
        try {
          initChart();
          renderMiniCalendar();
        } catch (e) { console.warn("Chart/Cal error", e); }

        // Render Table (Independent)
        await loadRecentAbsensi();

      } catch (err) {
        console.error(err);
      }
    }

    async function loadRecentAbsensi() {
      const tbody = document.getElementById('recentAbsensi');
      tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-slate-500">Memuat data...</td></tr>';

      try {
        // 1. Try to fetch with join
        let absensi = await Data.getAbsensiWithPegawai({ limit: 10 });

        // 2. If empty or no pegawai data, try fallback
        if (!absensi || absensi.length === 0) {
          // Try fallback: Get Absensi only
          const absensiOnly = await Data.getAbsensi({ limit: 10 });
          if (absensiOnly && absensiOnly.length > 0) {
            const allPegawai = await Data.getPegawai();

            absensi = absensiOnly.map(a => {
              return {
                ...a,
                pegawai: allPegawai.find(p => p.id === a.pegawai_id) || {}
              };
            });
          }
        }

        if (!absensi || absensi.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-slate-500">Belum ada data absensi</td></tr>';
          return;
        }

        tbody.innerHTML = absensi.map(abs => {
          const nama = abs.pegawai?.nama || 'Tanpa Nama';
          const nip = abs.pegawai?.nip || '-';
          const avatar = `https://ui-avatars.com/api/?name=${encodeURIComponent(nama)}&background=random`;

          let statusClass = 'bg-slate-100 text-slate-600';
          if (abs.status === 'tepat_waktu' || abs.status === 'hadir') statusClass = 'bg-emerald-100 text-emerald-700';
          if (abs.status === 'terlambat') statusClass = 'bg-amber-100 text-amber-700';

          return `
              <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
                <td class="px-6 py-4">
                  <div class="flex items-center gap-3">
                    <img src="${avatar}" class="size-8 rounded-full">
                    <div>
                      <h5 class="text-sm font-medium text-slate-900 dark:text-white">${nama}</h5>
                      <p class="text-xs text-slate-500">${nip}</p>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 font-medium text-slate-700 dark:text-slate-300">
                  ${abs.jam_masuk || '--:--'} WIB
                </td>
                <td class="px-6 py-4">
                  <span class="px-2.5 py-1 rounded text-xs font-semibold ${statusClass}">
                    ${abs.status}
                  </span>
                </td>
                <td class="px-6 py-4 text-slate-500">
                   ${abs.lokasi_masuk || 'Kantor'}
                </td>
                <td class="px-6 py-4 text-right">
                  <button class="text-slate-400 hover:text-slate-600" onclick="viewDetailAbsensi('${abs.id}')">
                    <span class="material-symbols-outlined text-[20px]">more_vert</span>
                  </button>
                </td>
              </tr>
              `;
        }).join('');

      } catch (e) {
        console.error("Error loading table", e);
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Gagal memuat data. Periksa koneksi internet.</td></tr>';
      }
    }

    // View Detail
    async function viewDetailAbsensi(id) {
      // (Simplify for brevity, assume similar logic to previous)
      App.openModal('detailAbsensiModal');
    }

    // Chart Logic (Reused)
    async function initChart() {
      const ctx = document.getElementById('attendanceChart').getContext('2d');
      const weekData = [120, 130, 115, 140, 110, 50, 20]; // Dummy for now

      if (attendanceChart) attendanceChart.destroy();

      attendanceChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'],
          datasets: [{
            label: 'Hadir',
            data: weekData,
            backgroundColor: '#135bec',
            borderRadius: 4,
            barThickness: 30
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, grid: { display: false }, ticks: { display: false } },
            x: { grid: { display: false } }
          }
        }
      });
    }

    // Calendar
    function renderMiniCalendar() {
      const grid = document.getElementById('miniCalendarGrid');
      const monthLabel = document.getElementById('calendarMonth');
      if (!grid || !monthLabel) return;

      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      const now = new Date();

      const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
      monthLabel.textContent = `${monthNames[month]} ${year}`;

      grid.innerHTML = '';

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      for (let i = 0; i < firstDay; i++) {
        const empty = document.createElement('div');
        empty.className = 'calendar-day empty';
        grid.appendChild(empty);
      }

      for (let d = 1; d <= daysInMonth; d++) {
        const dayEl = document.createElement('div');
        dayEl.className = 'calendar-day';
        dayEl.textContent = d;

        if (d === now.getDate() && month === now.getMonth() && year === now.getFullYear()) {
          dayEl.classList.add('active');
        }
        grid.appendChild(dayEl);
      }
    }

    document.getElementById('prevMonth')?.addEventListener('click', function () {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
      renderMiniCalendar();
    });

    document.getElementById('nextMonth')?.addEventListener('click', function () {
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
      renderMiniCalendar();
    });
  </script>
</body>

</html>