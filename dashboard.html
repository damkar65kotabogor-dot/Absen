<!DOCTYPE html>
<html class="light" lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Dashboard - SIMPEG PPPK</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,100..900;1,100..900&amp;display=swap"
    rel="stylesheet" />
  <!-- Material Symbols -->
  <link
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
    rel="stylesheet" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <!-- Tailwind Config -->
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#135bec",
            "background-light": "#f6f6f8",
            "background-dark": "#101622",
          },
          fontFamily: {
            "display": ["Public Sans", "sans-serif"]
          },
          borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
        },
      },
    }
  </script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" async></script>
  <!-- Lucide -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* Calendar Grid Specifics */
    .calendar-day {
      aspect-ratio: 1/1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 9999px;
      cursor: pointer;
      font-size: 0.875rem;
    }

    .calendar-day:hover {
      background-color: #f8fafc;
    }

    .dark .calendar-day:hover {
      background-color: #1e293b;
    }

    .calendar-day.active {
      background-color: #135bec;
      color: white;
    }

    .calendar-day.empty {
      background: transparent;
      cursor: default;
    }
  </style>
</head>

<body
  class="font-display bg-background-light dark:bg-background-dark text-slate-900 dark:text-white h-screen flex overflow-hidden">

  <!-- Sidebar Overlay -->
  <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-20 hidden lg:hidden" onclick="toggleSidebar()"></div>

  <!-- Sidebar -->
  <aside id="sidebar"
    class="w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col flex-shrink-0 transition-all duration-300 z-30 fixed lg:relative h-full -translate-x-full lg:translate-x-0">
    <!-- Logo Area -->
    <a href="dashboard.html"
      class="h-16 flex items-center gap-3 px-6 border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
      <div class="size-8 rounded-lg bg-primary flex items-center justify-center text-white">
        <span class="material-symbols-outlined text-xl">badge</span>
      </div>
      <div>
        <h1 class="text-base font-bold text-slate-900 dark:text-white leading-none">Absensi</h1>
        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">PPPK Paruh Waktu</p>
      </div>
    </a>
    <!-- Navigation -->
    <div class="flex-1 overflow-y-auto py-4 px-3 flex flex-col gap-1">
      <p class="px-3 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 mt-2">Menu Utama</p>
      <a id="nav-dashboard"
        class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-primary/10 text-primary group transition-colors"
        href="dashboard.html">
        <span class="material-symbols-outlined text-[20px]">dashboard</span>
        <span class="text-sm font-medium">Dashboard</span>
      </a>

      <div id="group-kepegawaian">
        <p class="px-3 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 mt-6">Kepegawaian</p>
        <a id="nav-pegawai"
          class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 group transition-colors"
          href="pegawai.html">
          <span class="material-symbols-outlined text-[20px]">group</span>
          <span class="text-sm font-medium">Data Pegawai</span>
        </a>
      </div>

      <p class="px-3 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 mt-6">Kehadiran</p>
      <a id="nav-absensi"
        class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 group transition-colors"
        href="absensi.html">
        <span class="material-symbols-outlined text-[20px]">schedule</span>
        <span class="text-sm font-medium">Absensi</span>
      </a>
      <a id="nav-cuti"
        class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 group transition-colors"
        href="cuti.html">
        <span class="material-symbols-outlined text-[20px]">calendar_month</span>
        <span class="text-sm font-medium">Pengajuan Cuti</span>
      </a>

      <p class="px-3 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 mt-6">Sistem</p>
      <a id="nav-setting"
        class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 group transition-colors"
        href="setting.html">
        <span class="material-symbols-outlined text-[20px]">settings</span>
        <span class="text-sm font-medium">Pengaturan</span>
      </a>
      <a id="nav-profil"
        class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 group transition-colors"
        href="profil.html">
        <span class="material-symbols-outlined text-[20px]">account_circle</span>
        <span class="text-sm font-medium">Profil</span>
      </a>
    </div>
    <!-- User Profile Footer -->
    <div class="p-4 border-t border-slate-100 dark:border-slate-800">
      <div class="flex items-center gap-3">
        <div class="size-10 rounded-full bg-slate-200 dark:bg-slate-700 bg-cover bg-center user-avatar"
          style="background-image: url('https://ui-avatars.com/api/?name=Admin&background=0D8ABC&color=fff');">
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium text-slate-900 dark:text-white truncate user-name">User</p>
          <p class="text-xs text-slate-500 dark:text-slate-400 truncate user-role">Role</p>
        </div>
        <button class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200" onclick="Auth.logout()">
          <span class="material-symbols-outlined text-[20px]">logout</span>
        </button>
      </div>
    </div>
  </aside>

  <!-- Sidebar Pegawai (Blue Theme) -->
  <aside id="sidebarPegawai"
    class="w-64 bg-[#1e3a8a] text-white flex flex-col flex-shrink-0 transition-all duration-300 z-30 fixed lg:relative h-full -translate-x-full lg:translate-x-0 hidden">

    <!-- Profile Header -->
    <div class="p-6">
      <div class="flex items-center gap-4 mb-2">
        <div class="size-14 rounded-full border-2 border-white/50 p-0.5">
          <div class="w-full h-full rounded-full bg-cover bg-center user-avatar"
            style="background-image: url('https://ui-avatars.com/api/?name=User');"></div>
        </div>
      </div>
      <h2 class="text-lg font-bold leading-tight user-name">Nama Pegawai</h2>
      <p class="text-xs text-blue-200 mt-1 mb-3 user-nip">NIP. -</p>
      <span class="inline-block bg-white/20 px-3 py-1 rounded-full text-[10px] font-medium tracking-wide">Pegawai
        PPPK</span>
    </div>

    <!-- Navigation -->
    <div class="flex-1 overflow-y-auto px-4 py-2 flex flex-col gap-6">

      <!-- Menu Utama -->
      <div>
        <p class="text-[10px] font-bold text-blue-300/80 uppercase tracking-widest mb-3">MENU UTAMA</p>
        <a href="dashboard.html"
          class="flex items-center gap-3 px-4 py-3 rounded-xl bg-white text-blue-900 shadow-lg shadow-blue-900/20 font-bold transition-transform active:scale-95">
          <span class="material-symbols-outlined">dashboard</span>
          <span>Dashboard</span>
        </a>
      </div>

      <!-- Aktivitas Pegawai -->
      <div>
        <p class="text-[10px] font-bold text-blue-300/80 uppercase tracking-widest mb-3">AKTIVITAS PEGAWAI</p>
        <div class="space-y-1">
          <a href="absensi.html"
            class="flex items-center gap-3 px-4 py-3 rounded-xl text-blue-100 hover:bg-white/10 transition-colors">
            <span class="material-symbols-outlined">check_box</span>
            <span class="font-medium">Absensi</span>
          </a>
          <a href="cuti.html"
            class="flex items-center gap-3 px-4 py-3 rounded-xl text-blue-100 hover:bg-white/10 transition-colors">
            <span class="material-symbols-outlined">umbrella</span>
            <span class="font-medium">Pengajuan Cuti</span>
          </a>
          <a href="absensi.html"
            class="flex items-center gap-3 px-4 py-3 rounded-xl text-blue-100 hover:bg-white/10 transition-colors">
            <span class="material-symbols-outlined">history</span>
            <span class="font-medium">Riwayat</span>
          </a>
        </div>
      </div>

      <!-- Pengaturan -->
      <div>
        <p class="text-[10px] font-bold text-blue-300/80 uppercase tracking-widest mb-3">PENGATURAN</p>
        <a href="profil.html"
          class="flex items-center gap-3 px-4 py-3 rounded-xl text-blue-100 hover:bg-white/10 transition-colors">
          <span class="material-symbols-outlined">settings</span>
          <span class="font-medium">Akun</span>
        </a>
      </div>

    </div>

    <!-- Footer -->
    <div class="p-6 border-t border-white/10">
      <button onclick="Auth.logout()"
        class="flex items-center gap-3 text-blue-200 hover:text-white transition-colors w-full">
        <span class="material-symbols-outlined -scale-x-100">logout</span>
        <span class="font-medium">Keluar Aplikasi</span>
      </button>
      <p class="text-center text-[10px] text-blue-400 mt-6">Versi 1.0.2</p>
    </div>
  </aside>

  <!-- ==================== ADMIN DASHBOARD CONTENT ==================== -->
  <main class="flex-1 flex flex-col h-full relative overflow-hidden" id="adminDashboard">
    <!-- Header -->
    <header
      class="h-16 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-6 z-10">
      <div class="flex items-center gap-4">
        <button class="lg:hidden text-slate-500 hover:text-slate-700" onclick="toggleSidebar()">
          <span class="material-symbols-outlined">menu</span>
        </button>
        <h2 class="text-xl font-bold text-slate-800 dark:text-white tracking-tight">Dashboard Admin</h2>
      </div>
      <div class="flex items-center gap-4">
        <div class="hidden md:flex items-center bg-slate-100 dark:bg-slate-800 rounded-lg px-3 py-2 w-64">
          <span class="material-symbols-outlined text-slate-400 text-[20px]">search</span>
          <input
            class="bg-transparent border-none outline-none text-sm ml-2 w-full text-slate-700 dark:text-slate-200 placeholder:text-slate-400 focus:ring-0"
            placeholder="Cari pegawai..." type="text" />
        </div>
        <div class="flex items-center gap-2">
          <!-- Admin Actions -->
        </div>
      </div>
    </header>

    <!-- Scrollable content -->
    <div class="flex-1 overflow-y-auto p-4 md:p-8">
      <div class="max-w-7xl mx-auto space-y-6">
        <!-- Headline -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <h3 class="text-2xl font-bold text-slate-900 dark:text-white">Ringkasan Hari Ini</h3>
            <p class="text-slate-500 dark:text-slate-400 text-sm mt-1 currentDateFull">Memuat tanggal...</p>
          </div>
          <div class="flex gap-3">
            <button onclick="addManualAbsensi()"
              class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-lg shadow-blue-500/30 flex items-center gap-2">
              <span class="material-symbols-outlined text-[18px]">add</span>
              Absensi Manual
            </button>
          </div>
        </div>

        <!-- Global Stats Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <!-- Repeat Card Logic from previous but ensure IDs are unique if needed or accept replace -->
          <!-- ... (Using same IDs as previous file for compatibility) ... -->
          <div
            class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Total Pegawai</p>
                <h4 class="text-2xl font-bold text-slate-900 dark:text-white mt-2" id="statTotalPegawai">0</h4>
              </div>
              <div class="p-2 bg-blue-50 text-blue-600 rounded-lg"><span class="material-symbols-outlined">groups</span>
              </div>
            </div>
          </div>
          <div
            class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Hadir</p>
                <h4 class="text-2xl font-bold text-slate-900 dark:text-white mt-2" id="statHadir">0</h4>
              </div>
              <div class="p-2 bg-emerald-50 text-emerald-600 rounded-lg"><span
                  class="material-symbols-outlined">check_circle</span></div>
            </div>
          </div>
          <div
            class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Terlambat</p>
                <h4 class="text-2xl font-bold text-slate-900 dark:text-white mt-2" id="statTerlambat">0</h4>
              </div>
              <div class="p-2 bg-amber-50 text-amber-600 rounded-lg"><span
                  class="material-symbols-outlined">schedule</span></div>
            </div>
          </div>
          <div
            class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Absen</p>
                <h4 class="text-2xl font-bold text-slate-900 dark:text-white mt-2" id="statAbsen">0</h4>
              </div>
              <div class="p-2 bg-rose-50 text-rose-600 rounded-lg"><span class="material-symbols-outlined">cancel</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div
          class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
          <div class="p-6 border-b border-slate-200 dark:border-slate-800">
            <h3 class="text-lg font-bold">Riwayat Absensi Terkini</h3>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
              <tbody id="recentAbsensi" class="divide-y divide-slate-100"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ==================== PEGAWAI DASHBOARD CONTENT ==================== -->
  <main class="flex-1 h-full bg-slate-50 relative pb-24 overflow-y-auto" id="pegawaiDashboard" style="display: none;">

    <!-- Top Header -->
    <div class="px-6 pt-8 pb-4 bg-white sticky top-0 z-10">
      <div class="flex items-center justify-between mb-6">
        <button onclick="toggleSidebar()" class="text-slate-800 focus:outline-none">
          <span class="material-symbols-outlined text-[28px]">menu</span>
        </button>
        <h1 class="text-lg font-bold text-slate-800">PPPK Paruh Waktu</h1>
        <div class="relative">
          <span class="material-symbols-outlined text-slate-800 text-[28px]">notifications</span>
          <span class="absolute top-0 right-0 size-2.5 bg-red-500 rounded-full border-2 border-white"></span>
        </div>
      </div>

      <div class="mb-2">
        <p class="text-slate-500 text-sm">Selamat Pagi,</p>
        <h2 class="text-2xl font-bold text-slate-900 user-firstName">Nama Pegawai</h2>
      </div>
    </div>

    <div class="px-6 space-y-6">
      <!-- Summary Header -->
      <div class="flex items-center justify-between">
        <div>
          <h3 class="font-bold text-slate-800">Ringkasan</h3>
          <p class="text-xs text-slate-500">Aktivitas Hari Ini</p>
        </div>
        <div class="bg-white px-3 py-1.5 rounded-lg border border-slate-200 shadow-sm flex items-center gap-2">
          <span class="material-symbols-outlined text-primary text-[18px]">calendar_today</span>
          <span class="text-xs font-semibold text-slate-600 currentDateFull">...</span>
        </div>
      </div>

      <!-- Blue Status Card -->
      <div class="bg-primary rounded-[20px] p-6 text-white relative overflow-hidden shadow-xl shadow-blue-500/30">
        <!-- Background Decoration -->
        <div class="absolute -right-10 -bottom-10 size-40 bg-white/10 rounded-full"></div>
        <div class="absolute -top-10 -left-10 size-32 bg-white/5 rounded-full"></div>

        <p class="text-sm text-white/80 mb-1">Status Kehadiran</p>
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-3xl font-bold mb-3" id="lblPegawaiStatus">Hadir</h2>
            <div class="inline-flex items-center gap-1.5 bg-white/20 px-3 py-1.5 rounded-lg backdrop-blur-sm">
              <span class="material-symbols-outlined text-[16px]">schedule</span>
              <span class="text-sm font-medium" id="lblPegawaiJam">Masuk: --:-- WIB</span>
            </div>
          </div>
          <div class="size-12 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
            <span class="material-symbols-outlined text-[28px]">check</span>
          </div>
        </div>
      </div>

      <!-- Menu Grid -->
      <div class="space-y-4">
        <!-- Profil Saya -->
        <a href="profil.html" class="block bg-white p-4 rounded-[20px] shadow-sm flex items-center justify-between">
          <div class="flex items-center gap-4">
            <div class="size-12 rounded-full bg-blue-50 flex items-center justify-center text-primary">
              <span class="material-symbols-outlined text-[24px]">person</span>
            </div>
            <div>
              <h4 class="font-bold text-slate-800">Profil Saya</h4>
              <p class="text-xs text-slate-500">Kelola data kepegawaian</p>
            </div>
          </div>
          <span class="material-symbols-outlined text-slate-400">chevron_right</span>
        </a>

        <div class="grid grid-cols-2 gap-4">
          <!-- Rekapitulasi -->
          <a href="absensi.html"
            class="bg-white p-5 rounded-[20px] shadow-sm flex flex-col items-center justify-center text-center gap-3 h-36">
            <div class="size-12 rounded-full bg-orange-50 flex items-center justify-center text-orange-500">
              <span class="material-symbols-outlined text-[24px]">assignment</span>
            </div>
            <div>
              <h4 class="font-bold text-slate-800 text-sm">Rekapitulasi</h4>
              <p class="text-[10px] font-bold text-orange-500 uppercase tracking-wider mt-0.5">KEHADIRAN</p>
            </div>
          </a>

          <!-- Fleksibilitas -->
          <a href="#"
            class="bg-white p-5 rounded-[20px] shadow-sm flex flex-col items-center justify-center text-center gap-3 h-36">
            <div class="size-12 rounded-full bg-emerald-50 flex items-center justify-center text-emerald-500">
              <span class="material-symbols-outlined text-[24px]">schedule</span>
            </div>
            <div>
              <h4 class="font-bold text-slate-800 text-sm">Fleksibilitas</h4>
              <p class="text-[10px] font-bold text-emerald-500 uppercase tracking-wider mt-0.5">KERJA</p>
            </div>
          </a>
        </div>
      </div>
    </div>

    <!-- Bottom Navigation Bar -->
    <div class="fixed bottom-0 left-0 right-0 h-24 pointer-events-none flex items-end justify-center z-50">
      <!-- Bar Container -->
      <div class="pointer-events-auto flex items-center gap-4 px-6 pb-6 w-full max-w-lg">

        <!-- Button Datang -->
        <button id="btnPegawaiCheckIn" onclick="handlePegawaiCheckIn()"
          class="bg-emerald-500 hover:bg-emerald-600 active:scale-95 transition-all text-white h-12 flex-1 rounded-full flex flex-col items-center justify-center shadow-lg shadow-emerald-500/20 group">
          <div class="flex items-center gap-2">
            <span class="material-symbols-outlined text-[20px]">login</span>
            <span class="font-semibold text-sm">Datang</span>
          </div>
        </button>

        <!-- Center Home Button -->
        <button
          class="bg-[#1e2756] text-white size-16 rounded-full flex flex-col items-center justify-center shadow-xl border-4 border-slate-50 relative -top-3 z-10 active:scale-95 transition-transform">
          <span class="material-symbols-outlined text-[28px] mb-0.5">home</span>
          <span class="text-[9px] font-medium">Beranda</span>
        </button>

        <!-- Button Pulang -->
        <button id="btnPegawaiCheckOut" onclick="handlePegawaiCheckOut()"
          class="bg-red-600 hover:bg-red-700 active:scale-95 transition-all text-white h-12 flex-1 rounded-full flex flex-col items-center justify-center shadow-lg shadow-red-600/20 group">
          <div class="flex items-center gap-2">
            <span class="material-symbols-outlined text-[20px]">logout</span>
            <span class="font-semibold text-sm">Pulang</span>
          </div>
        </button>

      </div>
    </div>

  </main>

  <!-- Modals (Manual Attendance for Admin) -->
  <div id="manualAttendanceModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="relative bg-white dark:bg-slate-900 rounded-xl shadow-xl w-full max-w-md p-6">
      <h3 class="text-lg font-bold mb-4">Absensi Manual</h3>
      <form id="manualAttendanceForm" class="space-y-4">
        <input type="hidden" id="editAbsensiId">
        <select id="manualPegawai" class="w-full rounded-lg border-slate-200 text-sm"></select>
        <input type="date" id="manualTanggal" class="w-full rounded-lg border-slate-200 text-sm">
        <div class="grid grid-cols-2 gap-4">
          <input type="time" id="manualJamMasuk" class="w-full rounded-lg border-slate-200 text-sm">
          <input type="time" id="manualJamKeluar" class="w-full rounded-lg border-slate-200 text-sm">
        </div>
        <select id="manualStatus" class="w-full rounded-lg border-slate-200 text-sm">
          <option value="tepat_waktu">Tepat Waktu</option>
          <option value="terlambat">Terlambat</option>
        </select>
      </form>
      <div class="mt-6 flex justify-end gap-2">
        <button onclick="closeManualModal()" class="btn border px-4 py-2 rounded-lg text-sm">Batal</button>
        <button onclick="submitManualAttendance()"
          class="btn bg-primary text-white px-4 py-2 rounded-lg text-sm">Simpan</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-client.js"></script>
  <script src="js/data.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/app.js"></script>

  <script>
    // --- SHARED UI LOGIC ---
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar'); // Admin sidebar
      const sidebarPegawai = document.getElementById('sidebarPegawai'); // Pegawai sidebar
      const overlay = document.getElementById('sidebarOverlay');

      // Determine which sidebar is active based on visibility class 'hidden' logic or just toggle the one that is NOT hidden by default logic? 
      // Actually simpler: just find which one is currently "active" in DOM structure or check role?
      // Better: Check if sidebarPegawai is NOT hidden class.

      if (!sidebarPegawai.classList.contains('hidden')) {
        sidebarPegawai.classList.toggle('-translate-x-full');
      } else {
        sidebar.classList.toggle('-translate-x-full');
      }

      overlay.classList.toggle('hidden');
    }

    // --- ADMIN LOGIC ---
    // (Consolidated from previous versions, keeping it functional)
    async function loadAdminDashboard() {
      // Stats
      try {
        const stats = await Data.getStats();
        document.getElementById('statTotalPegawai').textContent = stats.totalPegawai;
        document.getElementById('statHadir').textContent = stats.hadirHariIni;
        document.getElementById('statTerlambat').textContent = stats.terlambatHariIni;
        document.getElementById('statAbsen').textContent = stats.tidakHadir;
      } catch (e) { console.error(e); }

      // Table
      loadRecentAbsensi();
    }

    async function loadRecentAbsensi() {
      // Reuse robust logic 
      // ... (Simplified for brevity, assuming Data.getAbsensiWithPegawai works now)
      const tbody = document.getElementById('recentAbsensi');
      try {
        let absensi = await Data.getAbsensiWithPegawai({ limit: 5 });
        if (!absensi.length) {
          // Fallback attempt
          const abs = await Data.getAbsensi({ limit: 5 });
          const peg = await Data.getPegawai();
          absensi = abs.map(a => ({ ...a, pegawai: peg.find(p => p.id == a.pegawai_id) || {} }));
        }
        tbody.innerHTML = absensi.map(a => `
                <tr class="border-b border-slate-50 hover:bg-slate-50">
                    <td class="px-6 py-4 flex items-center gap-3">
                        <img src="https://ui-avatars.com/api/?name=${a.pegawai?.nama || 'U'}&background=random" class="size-8 rounded-full">
                        <div><p class="font-medium text-slate-900">${a.pegawai?.nama || '-'}</p></div>
                    </td>
                    <td class="px-6 py-4">${a.jam_masuk || '-'}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs bg-slate-100">${a.status}</span></td>
                </tr>
            `).join('');
      } catch (e) { tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-500">Gagal memuat</td></tr>'; }
    }

    // --- PEGAWAI LOGIC ---
    async function loadPegawaiDashboard(user) {
      // 1. Get Pegawai Data
      if (!user.pegawaiId) {
        const employees = await Data.getPegawai();
        const p = employees.find(x => x.user_id == user.id);
        if (p) {
          user.pegawaiId = p.id;
          localStorage.setItem('simpeg_current_user', JSON.stringify(user));
        }
      }

      // 2. Personal Stats
      try {
        const history = await Data.getAbsensi({ pegawai_id: user.pegawaiId, limit: 100 });
        const today = new Date().toISOString().split('T')[0];
        const currentMonth = today.slice(0, 7);

        // Stats Logic
        const thisMonth = history.filter(h => h.tanggal.startsWith(currentMonth));
        const statHadir = document.getElementById('myStatHadir'); // If these exist in new layout? No, used to be grid. 
        // Wait, new layout does NOT have stats grid "Hadir/Telat/Alpha" visible? 
        // The user image shows "Ringkasan Activities" with Calendar.
        // And a grid "Rekapitulasi" etc.
        // I should probably skip updating 'myStatHadir' etc if they don't exist, or leave them if I kept them hidden?
        // I removed them in the replacement. So I should NOT try to update them.

        // Recent Activity (Keep logic if element exists, or skip)
        // I kept 'myRecentAbsensi' container in the new HTML? No, I replaced content entirely.
        // New HTML has no list of recent activity shown in the code block I pushed?
        // Let's check Step 303.
        // It has `div class="px-6 space-y-6"` -> Summary Header -> Blue Status Card -> Menu Grid.
        // NO Recent Activity Table in new mobile design.
        // So REMOVE recent activity logic.

        // Check Today's Status
        const todayAbsen = history.find(h => h.tanggal === today);
        const btnCheckIn = document.getElementById('btnPegawaiCheckIn');
        const btnCheckOut = document.getElementById('btnPegawaiCheckOut');

        const lblStatus = document.getElementById('lblPegawaiStatus');
        const lblJam = document.getElementById('lblPegawaiJam');

        // Reset Default
        if (lblStatus) lblStatus.textContent = "Belum Hadir";
        if (lblJam) lblJam.textContent = "--:-- WIB";

        if (btnCheckIn) {
          btnCheckIn.disabled = false;
          btnCheckIn.classList.remove('opacity-50', 'grayscale');
        }
        if (btnCheckOut) {
          btnCheckOut.disabled = true;
          btnCheckOut.classList.add('opacity-50', 'grayscale');
        }

        if (todayAbsen) {
          if (todayAbsen.jam_keluar) {
            // Selesai
            if (lblStatus) lblStatus.textContent = "Sudah Pulang";
            if (lblJam) lblJam.textContent = `Masuk: ${todayAbsen.jam_masuk} | Keluar: ${todayAbsen.jam_keluar}`;

            if (btnCheckIn) { btnCheckIn.disabled = true; btnCheckIn.classList.add('opacity-50', 'grayscale'); }
            // Checkout disabled too
          } else {
            // Sedang Bekerja
            if (lblStatus) lblStatus.textContent = "Hadir";
            if (lblJam) lblJam.textContent = `Masuk: ${todayAbsen.jam_masuk} WIB`;

            if (btnCheckIn) { btnCheckIn.disabled = true; btnCheckIn.classList.add('opacity-50', 'grayscale'); }
            if (btnCheckOut) {
              btnCheckOut.disabled = false;
              btnCheckOut.classList.remove('opacity-50', 'grayscale');
            }
          }
        }

      } catch (e) { console.error("Pegawai Dashboard Error", e); }
    }

    async function handlePegawaiCheckIn() {
      const user = Auth.getCurrentUser();
      if (!user.pegawaiId) return alert('Data pegawai tidak ditemukan');

      // Location
      const isAtLocation = await App.validateLocation();
      if (!isAtLocation) return; // Msg handled in App

      const now = new Date();
      const jam = now.toTimeString().slice(0, 5);
      const status = jam <= '08:00' ? 'tepat_waktu' : 'terlambat';

      try {
        await Data.create('absensi', {
          pegawai_id: user.pegawaiId,
          tanggal: now.toISOString().split('T')[0],
          jam_masuk: jam,
          status: status
        });
        alert('Check In Berhasil!');
        loadPegawaiDashboard(user);
      } catch (e) { alert('Gagal Check In'); }
    }

    async function handlePegawaiCheckOut() {
      const user = Auth.getCurrentUser();
      // Find today's ID
      const today = new Date().toISOString().split('T')[0];
      const history = await Data.getAbsensi({ pegawai_id: user.pegawaiId, tanggal: today });
      if (!history[0]) return;

      try {
        await Data.update('absensi', history[0].id, {
          jam_keluar: new Date().toTimeString().slice(0, 5)
        });
        alert('Check Out Berhasil!');
        loadPegawaiDashboard(user);
      } catch (e) { alert('Gagal Check Out'); }
    }

    // --- MAIN INIT ---
    async function loadDashboard() {
      try {
        const user = Auth.getCurrentUser();
        if (!user) return window.location.href = 'index.html';

        // Common UI updates
        const dateStr = new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        document.querySelectorAll('.currentDateFull').forEach(el => el.textContent = dateStr);
        document.querySelectorAll('.user-name').forEach(el => el.textContent = user.name || user.username);
        document.querySelectorAll('.user-role').forEach(el => el.textContent = user.role);
        document.querySelector('.user-firstName').textContent = (user.name || 'User').split(' ')[0];

        // Avatar
        const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || 'U')}&background=0D8ABC&color=fff`;
        document.querySelectorAll('.user-avatar').forEach(el => el.style.backgroundImage = `url('${avatarUrl}')`);

        if (user.role === 'pegawai') {
          // Show Pegawai View
          document.getElementById('adminDashboard').style.display = 'none';
          document.getElementById('pegawaiDashboard').style.display = 'block';

          // Toggle Sidebars
          document.getElementById('sidebar').classList.add('hidden'); // Hide Admin sidebar completely
          document.getElementById('sidebarPegawai').classList.remove('hidden'); // Show Pegawai sidebar
          document.getElementById('sidebarPegawai').classList.remove('-translate-x-full'); // Ensure visible on desktop

          // Load Pegawai Data
          await loadPegawaiDashboard(user);

          // Populate additional sidebar info
          const nip = user.nip || (user.pegawaiId ? (await Data.getById('pegawai', user.pegawaiId))?.nip : '-') || '-';
          document.querySelectorAll('.user-nip').forEach(el => el.textContent = `NIP. ${nip}`);

        } else {
          // Show Admin View
          document.getElementById('adminDashboard').style.display = 'flex';
          document.getElementById('pegawaiDashboard').style.display = 'none';

          // Toggle Sidebars
          document.getElementById('sidebar').classList.remove('hidden');
          document.getElementById('sidebarPegawai').classList.add('hidden');

          await loadAdminDashboard();
        }

      } catch (e) { console.error('Init Error', e); }
    }

    // Modal Helpers for Admin (retained for compatibility)
    function closeManualModal() { document.getElementById('manualAttendanceModal').classList.add('hidden'); }
    async function addManualAbsensi() {
      const employees = await Data.getPegawai();
      document.getElementById('manualPegawai').innerHTML = employees.map(p => `<option value="${p.id}">${p.nama}</option>`).join('');
      document.getElementById('manualAttendanceModal').classList.remove('hidden');
    }

    async function submitManualAttendance() {
      const pegawaiId = document.getElementById('manualPegawai').value;
      const tanggal = document.getElementById('manualTanggal').value;
      const jamMasuk = document.getElementById('manualJamMasuk').value;
      const jamKeluar = document.getElementById('manualJamKeluar').value;
      const status = document.getElementById('manualStatus').value;

      if (!pegawaiId || !tanggal) return alert('Mohon lengkapi data');

      const data = {
        pegawai_id: pegawaiId,
        tanggal: tanggal,
        jam_masuk: jamMasuk || null,
        jam_keluar: jamKeluar || null,
        status: status
      };

      try {
        await Data.create('absensi', data);
        alert('Absensi berhasil ditambahkan');
        closeManualModal();
        loadAdminDashboard();
      } catch (e) {
        alert('Gagal menyimpan');
        console.error(e);
      }
    }
    // Initialize Dashboard logic
    document.addEventListener('DOMContentLoaded', () => {
      loadDashboard();
    });
  </script>
</body>

</html>