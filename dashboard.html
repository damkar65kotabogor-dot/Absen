<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Dashboard - SIMPEG PPPK">
  <meta name="theme-color" content="#3b82f6">
  <title>Dashboard - SIMPEG PPPK Paruh Waktu</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css?v=1.3">
  <link rel="icon" href="img/logo.png" type="image/png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js" async></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
  <div class="app-container">
    <!-- Sidebar Overlay (Mobile) -->
    <div class="sidebar-overlay" onclick="App.closeMobileSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <i data-lucide="building-2"></i>
        </div>
        <div class="sidebar-brand">
          <h1>Absensi PPPK</h1>
          <span>Admin Dashboard</span>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <span class="nav-section-title">MENU UTAMA</span>
          <a href="dashboard.html" class="nav-item active">
            <i data-lucide="layout-dashboard"></i>
            <span>Dashboard</span>
          </a>
          <a href="pegawai.html" class="nav-item">
            <i data-lucide="users"></i>
            <span>Data Pegawai</span>
          </a>
          <a href="cuti.html" class="nav-item">
            <i data-lucide="calendar-days"></i>
            <span>Pengajuan Cuti</span>
          </a>
          <a href="absensi.html" class="nav-item">
            <i data-lucide="file-text"></i>
            <span>Laporan Absen</span>
          </a>
        </div>

        <div class="nav-section">
          <span class="nav-section-title">SISTEM</span>
          <a href="setting.html" class="nav-item">
            <i data-lucide="settings"></i>
            <span>Pengaturan</span>
          </a>
          <a href="profil.html" class="nav-item">
            <i data-lucide="user-circle"></i>
            <span>Profil Admin</span>
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <a href="#" class="nav-item text-danger" onclick="Auth.logout()">
          <i data-lucide="log-out"></i>
          <span>Logout</span>
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="adminDashboard" style="display: none;">
      <!-- Top Header -->
      <header class="top-header" style="background: transparent; box-shadow: none; padding: 0.5rem 0;">
        <div class="header-left">
          <button class="toggle-sidebar" id="toggleSidebar"
            onclick="document.getElementById('sidebar').classList.toggle('collapsed'); document.querySelector('.main-content').classList.toggle('sidebar-collapsed');">
            <i data-lucide="menu"></i>
          </button>
          <div class="page-title">
            <h1
              style="font-size: 1.75rem; color: var(--gray-900); font-weight: 800; display: flex; align-items: center; gap: 0.5rem;">
              Dashboard
            </h1>
          </div>
        </div>
        <div class="header-right">
          <div class="search-box" id="headerSearch">
            <i data-lucide="search"></i>
            <input type="text" class="search-input" placeholder="Cari pegawai...">
          </div>
          <button class="header-btn">
            <i data-lucide="bell"></i>
            <span class="badge">3</span>
          </button>
          <button class="header-btn">
            <i data-lucide="help-circle"></i>
          </button>
          <div class="header-user-profile">
            <!-- <img src="https://ui-avatars.com/api/?name=Admin&background=0D8ABC&color=fff" alt="Admin"
              class="user-avatar" style="width: 36px; height: 36px;"> -->
          </div>
        </div>
      </header>

      <div class="dashboard-container-redesign">

        <!-- Welcome / Actions Row -->
        <div class="flex justify-between items-end mb-4"
          style="display: flex; justify-content: space-between; align-items: flex-end;">
          <div class="dashboard-header-intro" style="margin-bottom: 0;">
            <h2 class="dashboard-main-title">Ringkasan Hari Ini</h2>
            <p class="dashboard-main-subtitle" id="currentDateFull">Senin, 24 Oktober 2023</p>
          </div>
          <div class="header-actions">
            <button class="btn-download" onclick="downloadReport()">
              <i data-lucide="download"></i> Unduh Laporan
            </button>
            <button class="btn-add" onclick="window.location.href='absensi.html'">
              <i data-lucide="plus"></i> Absensi Manual
            </button>
          </div>
        </div>

        <!-- 4 Stats Grid -->
        <div class="stats-grid-redesign">
          <!-- Card 1 -->
          <div class="stat-card-redesign">
            <div class="stat-card-inner">
              <div class="stat-content-redesign">
                <span class="stat-label-redesign">Total Pegawai</span>
                <span class="stat-value-redesign" id="statTotalPegawai">0</span>
                <span class="stat-subtext-redesign green-text" id="statPegawaiChange">+12 <span
                    style="font-weight: 400; color: var(--gray-500);">bulan ini</span></span>
              </div>
              <div class="stat-icon-wrapper-redesign blue-bg">
                <i data-lucide="users"></i>
              </div>
            </div>
          </div>
          <!-- Card 2 -->
          <div class="stat-card-redesign">
            <div class="stat-card-inner">
              <div class="stat-content-redesign">
                <span class="stat-label-redesign">Hadir Tepat Waktu</span>
                <span class="stat-value-redesign" id="statHadir">0</span>
                <span class="stat-subtext-redesign green-text" id="statHadirPersen">88.7% <span
                    style="font-weight: 400; color: var(--gray-500);">dari total pegawai</span></span>
              </div>
              <div class="stat-icon-wrapper-redesign green-bg">
                <i data-lucide="check-circle-2"></i>
              </div>
            </div>
          </div>
          <!-- Card 3 -->
          <div class="stat-card-redesign">
            <div class="stat-card-inner">
              <div class="stat-content-redesign">
                <span class="stat-label-redesign">Terlambat</span>
                <span class="stat-value-redesign" id="statTerlambat">0</span>
                <span class="stat-subtext-redesign orange-text" id="statTerlambatChange">+5 <span
                    style="font-weight: 400; color: var(--gray-500);">dari kemarin</span></span>
              </div>
              <div class="stat-icon-wrapper-redesign orange-bg">
                <i data-lucide="clock"></i>
              </div>
            </div>
          </div>
          <!-- Card 4 -->
          <div class="stat-card-redesign">
            <div class="stat-card-inner">
              <div class="stat-content-redesign">
                <span class="stat-label-redesign">Absen / Izin</span>
                <span class="stat-value-redesign" id="statAbsen">0</span>
                <span class="stat-subtext-redesign" style="color: var(--gray-500);">12 Tanpa Keterangan</span>
              </div>
              <div class="stat-icon-wrapper-redesign red-bg">
                <i data-lucide="x-circle"></i>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts & Calendar -->
        <div class="chart-calendar-container">
          <!-- Chart -->
          <div class="card p-4">
            <div class="card-header border-none" style="padding: 0; margin-bottom: 1rem; border: none;">
              <div style="display: flex; justify-content: space-between; width: 100%;">
                <div>
                  <h3 class="card-title">Tren Kehadiran</h3>
                  <p class="text-muted text-sm">Statistik mingguan (16 Okt-22 Okt)</p>
                </div>
                <button class="btn btn-sm btn-outline">Minggu Ini <i data-lucide="chevron-down" class="ml-1"
                    style="width: 14px;"></i></button>
              </div>
            </div>
            <div class="chart-wrapper">
              <canvas id="attendanceChart"></canvas>
            </div>
          </div>

          <!-- Calendar -->
          <div class="card p-4">
            <div class="calendar-widget">
              <div class="calendar-header">
                <h3 id="calendarMonth">Oktober 2023</h3>
                <div style="display: flex; gap: 4px;">
                  <button class="calendar-nav-btn"><i data-lucide="chevron-left" style="width: 16px;"></i></button>
                  <button class="calendar-nav-btn"><i data-lucide="chevron-right" style="width: 16px;"></i></button>
                </div>
              </div>
              <div class="calendar-grid-header">
                <div>Mn</div>
                <div>Sn</div>
                <div>Sl</div>
                <div>Rb</div>
                <div>Km</div>
                <div>Jm</div>
                <div>Sb</div>
              </div>
              <!-- Dummy Calendar Days for Visual -->
              <div class="calendar-grid-days" id="miniCalendarGrid">
                <!-- Populated via JS -->
              </div>

              <div class="mt-4" style="padding-top: 1rem; border-top: 1px solid var(--gray-100);">
                <div style="display: flex; gap: 1rem; font-size: 0.75rem;">
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="width: 8px; height: 8px; background: var(--primary-600); border-radius: 50%;"></div>
                    <span>Hari ini</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="width: 8px; height: 8px; background: var(--danger-500); border-radius: 50%;"></div>
                    <span>Libur Nasional (1)</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Attendance Table -->
        <div class="card">
          <div class="card-header border-none">
            <h3 class="card-title">Riwayat Absensi Terkini</h3>
            <div style="display: flex; gap: 1rem;">
              <button class="btn btn-sm btn-outline">Lihat Semua</button>
              <button class="btn btn-sm btn-outline"><i data-lucide="filter"
                  style="width: 14px; margin-right: 4px;"></i> Filter</button>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table-redesign">
                <thead>
                  <tr>
                    <th>PEGAWAI</th>
                    <th>WAKTU MASUK</th>
                    <th>STATUS</th>
                    <th>LOKASI</th>
                    <th>AKSI</th>
                  </tr>
                </thead>
                <tbody id="recentAbsensi">
                  <!-- Rows loaded via JS -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </main>

    <!-- Pegawai Experience (Mobile-First) -->
    <main class="mobile-app-wrapper" id="pegawaiDashboard" style="display: none;">

      <!-- Fixed Mobile Header -->
      <header class="app-header-mobile">
        <button class="toggle-sidebar" id="toggleSidebar" aria-label="Toggle Menu">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12" />
            <line x1="3" y1="6" x2="21" y2="6" />
            <line x1="3" y1="18" x2="21" y2="18" />
          </svg>
        </button>
        <span class="app-title-main">PPPK Paruh Waktu</span>
        <button class="notif-btn-wrapper" aria-label="Notifications">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
            <path d="M13.73 21a2 2 0 0 1-3.46 0" />
          </svg>
          <span class="dot-indicator" id="notifBadge" style="display: none;"></span>
        </button>
      </header>

      <!-- Scrollable Content Area -->
      <div class="scroll-area">

        <!-- Welcome Section -->
        <section class="welcome-box">
          <p class="txt-greeting">Selamat Pagi,</p>
          <h2 class="txt-user-name" id="greetingName">Memuat...</h2>
        </section>

        <!-- Dynamic White Shape Background Effect (Optional based on design) -->
        <div class="curve-bg-effect"></div>

        <!-- Activity Summary Header -->
        <div class="section-title-row">
          <div class="title-label">
            <h3>Ringkasan</h3>
            <p>Aktivitas Hari Ini</p>
          </div>
          <div class="pill-date-badge">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
              stroke="#3b82f6" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <span id="currentDateShort">Senin, 29 Des</span>
          </div>
        </div>

        <!-- Attendance Card (Blue Gradient) -->
        <div class="card-attendance-main">
          <div class="card-left">
            <span class="card-label">Status Kehadiran</span>
            <h2 class="card-status-text" id="statusText">Belum Hadir</h2>
            <div class="card-time-pill">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <span id="checkInTime">Masuk: --:-- WIB</span>
            </div>
          </div>
          <div class="card-right">
            <div class="icon-check-wrapper">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            </div>
          </div>
        </div>

        <!-- Menu Grid -->
        <div class="main-menu-container">
          <!-- Profile Card Wide -->
          <a href="profil.html" class="menu-item-wide">
            <div class="menu-icon-bg blue">
              <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>
            <div class="menu-info">
              <h4>Profil Saya</h4>
              <p>Kelola data kepegawaian</p>
            </div>
            <svg class="chevron-right" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
              fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </a>

          <!-- Grid 2 Columns -->
          <div class="menu-grid-2col">
            <a href="absensi.html" class="menu-item-square">
              <div class="icon-sq-bg orange">
                <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
              </div>
              <div class="sq-text">
                <h4>Rekapitulasi</h4>
                <p class="orange-label">KEHADIRAN</p>
              </div>
            </a>

            <a href="cuti.html" class="menu-item-square">
              <div class="icon-sq-bg teal">
                <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
              </div>
              <div class="sq-text">
                <h4>Fleksibilitas</h4>
                <p class="teal-label">KERJA</p>
              </div>
            </a>
          </div>
        </div>

        <!-- Space for Bottom Nav -->
        <div class="spacer-bottom"></div>
      </div>

      <!-- Action Bottom Bar -->
      <nav class="app-bottom-nav">
        <!-- Datang Button -->
        <button class="action-nav-btn btn-datang" id="btnCheckIn">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
            <polyline points="10 17 15 12 10 7"></polyline>
            <line x1="15" y1="12" x2="3" y2="12"></line>
          </svg>
          <span>Datang</span>
        </button>

        <!-- Home Floating Button -->
        <div class="home-nav-item">
          <div class="home-icon-circle">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="white"
              stroke="white" stroke-width="1">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
              <polyline points="9 22 9 12 15 12 15 22"></polyline>
            </svg>
          </div>
          <span class="home-text">Beranda</span>
        </div>

        <!-- Pulang Button -->
        <button class="action-nav-btn btn-pulang" id="btnCheckOut">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
          </svg>
          <span>Pulang</span>
        </button>
      </nav>

    </main>

    <!-- Action Menu Popover -->
    <div id="actionMenuPopover" class="action-menu-popover">
      <a href="#" class="action-menu-item" onclick="viewDetailAbsensi(); return false;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
        Lihat Detail
      </a>
      <a href="#" class="action-menu-item" onclick="editAbsensi(); return false;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
        Edit
      </a>
      <a href="#" class="action-menu-item text-danger" onclick="deleteAbsensi(); return false;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          Hapus
      </a>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay" style="z-index: 5000;">
      <div class="modal-content" style="max-width: 400px; text-align: center;">
        <div class="modal-body py-4">
          <div class="mb-3 text-primary" style="display: flex; justify-content: center;">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10" />
              <line x1="12" y1="16" x2="12" y2="12" />
              <line x1="12" y1="8" x2="12.01" y2="8" />
            </svg>
          </div>
          <p id="confirmMessage" style="font-size: 1.1rem; font-weight: 500; margin-bottom: 0;">Apakah Anda yakin?</p>
        </div>
        <div class="modal-footer" style="justify-content: center; gap: 12px; border: none; padding-top: 0;">
          <button class="btn btn-outline" onclick="closeConfirm()" style="min-width: 100px;">Batal</button>
          <button class="btn btn-primary" onclick="handleConfirm()" style="min-width: 100px;">Ya</button>
        </div>
      </div>
    </div>

    <!-- Edit Absensi Modal -->
    <div id="manualAttendanceModal" class="modal-overlay">
      <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
          <h3 class="modal-title">Edit Absensi Manual</h3>
          <button class="modal-close" onclick="App.closeModal('manualAttendanceModal')"
            aria-label="Close Modal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="manualAttendanceForm">
            <input type="hidden" id="editAbsensiId">

            <div class="form-group">
              <label for="manualPegawai">Pegawai <span style="color: red;">*</span></label>
              <select id="manualPegawai" class="form-control" required>
                <option value="">Pilih Pegawai</option>
              </select>
            </div>

            <div class="form-group">
              <label for="manualTanggal">Tanggal <span style="color: red;">*</span></label>
              <input type="date" id="manualTanggal" class="form-control" required>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div class="form-group">
                <label for="manualJamMasuk">Jam Masuk <span style="color: red;">*</span></label>
                <input type="time" id="manualJamMasuk" class="form-control" required>
              </div>

              <div class="form-group">
                <label for="manualJamKeluar">Jam Keluar</label>
                <input type="time" id="manualJamKeluar" class="form-control">
              </div>
            </div>

            <div class="form-group">
              <label for="manualStatus">Status <span style="color: red;">*</span></label>
              <select id="manualStatus" class="form-control" required>
                <option value="hadir">Hadir</option>
                <option value="izin">Izin</option>
                <option value="sakit">Sakit</option>
                <option value="alpha">Alpha</option>
              </select>
            </div>

            <div class="form-group">
              <label for="manualKeterangan">Keterangan</label>
              <textarea id="manualKeterangan" class="form-control" rows="3" placeholder="Opsional"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="App.closeModal('manualAttendanceModal')">Batal</button>
          <button class="btn btn-primary" onclick="saveManualAttendance()">Simpan</button>
        </div>
      </div>
    </div>

    <!-- Detail Absensi Modal -->
    <div id="detailAbsensiModal" class="modal-overlay">
      <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
          <h3 class="modal-title">Detail Absensi</h3>
          <button class="modal-close" onclick="App.closeModal('detailAbsensiModal')"
            aria-label="Close Modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">Pegawai</span>
              <span class="detail-value" id="detNama"></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Tanggal</span>
              <span class="detail-value" id="detTanggal"></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Status</span>
              <span class="detail-value" id="detStatus"></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Jam Masuk</span>
              <span class="detail-value" id="detJamMasuk"></span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Jam Keluar</span>
              <span class="detail-value" id="detJamKeluar">-</span>
            </div>
          </div>

          <div class="form-group mb-0 mt-3">
            <span class="detail-label">Keterangan</span>
            <p class="detail-value" id="detKeterangan">-</p>
          </div>

          <div id="detLokasiSection" class="mt-4">
            <span class="detail-label">Lokasi Check-in</span>
            <div id="detMapLinkMasuk"></div>
          </div>

          <div id="detFotoSection" class="mt-4">
            <span class="detail-label">Foto Selfie</span>
            <div class="detail-photo-container">
              <img id="detFoto" src="https://placehold.jp/24/f1f5f9/94a3b8/400x300.png?text=Tidak%20Ada%20Foto"
                alt="Selfie Absensi">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="App.closeModal('detailAbsensiModal')">Tutup</button>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <script src="js/data.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/app.js"></script>
    <script>
      // Require authentication
      if (!Auth.requireAuth()) {
        // Redirected to login
      }

      // Update current date
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const currentDateEl = document.getElementById('currentDate');
      if (currentDateEl) {
        currentDateEl.textContent = new Date().toLocaleDateString('id-ID', options);
      }
      const currentDateShortEl = document.getElementById('currentDateShort');
      if (currentDateShortEl) {
        const optionsShort = { weekday: 'long', day: 'numeric', month: 'short' };
        currentDateShortEl.textContent = new Date().toLocaleDateString('id-ID', optionsShort);
      }

      // Helper to get local date string YYYY-MM-DD
      function getLocalTodayDate() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      // Chart instance
      let attendanceChart = null;

      // Calendar state
      let currentCalendarDate = new Date();

      // Load dashboard data
      async function loadDashboard() {
        try {
          // Ensure data layer is ready
          await Data.isReady();

          const user = Auth.getCurrentUser();
          const stats = await Data.getStats();
          const totalPegawai = stats.totalPegawai;

          // Update Top Date
          const optionsFull = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
          const currentDateFullEl = document.getElementById('currentDateFull');
          if (currentDateFullEl) {
            currentDateFullEl.textContent = new Date().toLocaleDateString('id-ID', optionsFull);
          }

          // --- Stats 4 Cards Logic ---
          // 1. Total Pegawai
          const statTotal = document.getElementById('statTotalPegawai');
          if (statTotal) statTotal.textContent = totalPegawai;

          // 2. Hadir Tepat Waktu (Proxy: 'hadirHariIni' assuming they are on time effectively for this demo)
          // In real app, query specifically for status='tepat_waktu'
          const statHadir = document.getElementById('statHadir');
          if (statHadir) statHadir.textContent = stats.hadirHariIni;

          const statHadirPersen = document.getElementById('statHadirPersen');
          if (statHadirPersen) {
            const percent = totalPegawai > 0 ? ((stats.hadirHariIni / totalPegawai) * 100).toFixed(1) : 0;
            statHadirPersen.innerHTML = `${percent}% <span style="font-weight: 400; color: var(--gray-500);">dari total pegawai</span>`;
          }

          // 3. Terlambat
          // Mock data or fetch if available. For now, let's look at recent absensi and count 'terlambat'
          const allAbsensi = await Data.getAbsensiWithPegawai({ limit: 100 });
          const todayStr = getLocalTodayDate();
          const todayAbsen = allAbsensi.filter(a => a.tanggal === todayStr);

          const terlambatCount = todayAbsen.filter(a => a.status === 'terlambat').length;
          const statTerlambat = document.getElementById('statTerlambat');
          if (statTerlambat) statTerlambat.textContent = terlambatCount;

          // 4. Absen / Izin (Alpha or Izin/Sakit)
          // For simplicty: Total Pegawai - Hadir (including terlambat)
          const absenCount = totalPegawai - todayAbsen.length;
          const statAbsen = document.getElementById('statAbsen');
          if (statAbsen) statAbsen.textContent = Math.max(0, absenCount);


          // --- Render Chart ---
          renderAttendanceChart();

          // --- Render Calendar ---
          renderMiniCalendar();

          // --- Render Table Redesign ---
          const tbody = document.getElementById('recentAbsensi');
          if (tbody) {
            tbody.innerHTML = '';
            // Show top 5 recent
            const displayList = allAbsensi.slice(0, 5);

            displayList.forEach(abs => {
              const row = document.createElement('tr');

              // Status Badge Logic
              let statusBadgeClass = 'status-badge-soft absent';
              let statusText = abs.status || 'Alpha';

              if (abs.status === 'tepat_waktu' || abs.status === 'hadir') {
                statusBadgeClass = 'status-badge-soft present';
                statusText = 'Hadir';
              } else if (abs.status === 'terlambat') {
                statusBadgeClass = 'status-badge-soft late';
                statusText = 'Terlambat';
              } else if (abs.status === 'izin' || abs.status === 'sakit') {
                statusBadgeClass = 'status-badge-soft late'; // Use orange for permission too
              }

              // Location logic (mock or real)
              let lokasiDisplay = abs.lokasi_masuk ? 'Lokasi Terdeteksi' : '-';
              if (abs.lokasi_masuk && abs.lokasi_masuk.includes(',')) {
                // Try to get a short name if possible, otherwise just static text
                lokasiDisplay = 'Kantor Damkar';
              }

              row.innerHTML = `
                <td>
                  <div class="user-cell">
                    <img src="https://ui-avatars.com/api/?name=${encodeURIComponent(abs.nama_pegawai)}&background=random" alt="${abs.nama_pegawai}">
                    <div class="user-info-text">
                        <h4>${abs.nama_pegawai}</h4>
                        <p>${abs.nip || '-'}</p>
                    </div>
                  </div>
                </td>
                <td><span class="font-medium">${abs.jam_masuk || '--:--'} WIB</span></td>
                <td>
                  <span class="${statusBadgeClass}">
                    ${statusText}
                  </span>
                </td>
                <td>
                   <div style="display: flex; flex-direction: column;">
                      <span style="font-weight: 600; font-size: 0.8rem;">${lokasiDisplay}</span>
                      <span style="font-size: 0.75rem; color: var(--gray-500); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px;">
                        ${abs.lokasi_masuk || '-'}
                      </span>
                   </div>
                </td>
                <td>
                  <button class="btn-icon" style="color: var(--gray-400);" onclick="viewDetailAbsensi('${abs.id}')">
                    <i data-lucide="more-vertical"></i>
                  </button>
                </td>
              `;
              tbody.appendChild(row);
            });

            if (displayList.length === 0) {
              tbody.innerHTML = '<tr><td colspan="5" class="text-center p-4">Belum ada data absensi hari ini.</td></tr>';
            }
          }

          lucide.createIcons();

        } catch (error) {
          console.error('Error loading dashboard:', error);
          App.showToast('Gagal memuat data dashboard', 'error');
        }
      }

      function renderAttendanceChart() {
        const ctx = document.getElementById('attendanceChart');
        if (!ctx) return;

        if (attendanceChart) {
          attendanceChart.destroy();
        }

        // Dummy Weekly Data or aggregated real data if available
        // For visual match, using static dummy data
        const labels = ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'];
        const dataValues = [1200, 1220, 1190, 1240, 1000, 400, 200]; // drops on weekend

        attendanceChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Hadir',
              data: dataValues,
              backgroundColor: '#3b82f6',
              borderRadius: 4,
              barThickness: 24
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { display: false },
                ticks: { display: false } // Hide y-axis numbers for clean look
              },
              x: {
                grid: { display: false }
              }
            }
          }
        });
      }

      function renderMiniCalendar() {
        const grid = document.getElementById('miniCalendarGrid');
        const monthLabel = document.getElementById('calendarMonth');
        if (!grid || !monthLabel) return;

        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth();

        // Month Label
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        monthLabel.textContent = `${monthNames[month]} ${year}`;

        // Grid Generation
        grid.innerHTML = '';

        const firstDay = new Date(year, month, 1).getDay(); // 0 = Sunday
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Adjust for Monday start? The image shows "Mn" (Minggu) first or "Sen"? 
        // Image: Mn Sn Sl Rb Km Jm Sb. So Sunday start.

        // Empty slots for previous month
        for (let i = 0; i < firstDay; i++) {
          const empty = document.createElement('div');
          empty.className = 'calendar-day empty';
          grid.appendChild(empty);
        }

        for (let d = 1; d <= daysInMonth; d++) {
          const dayEl = document.createElement('div');
          dayEl.className = 'calendar-day';
          dayEl.textContent = d;

          if (d === now.getDate()) {
            dayEl.classList.add('active'); // Circle for today
          }
          // Add blue dot for today indicator if needed (image has specific indicators)

          grid.appendChild(dayEl);
        }
      }
      allAbsensi.forEach(a => {
        const u = a.unit_kerja || 'Lainnya';
        if (!units[u]) units[u] = { count: 0, total: 0 };
        units[u].count++;
      });

      // For demo/UI consistency, showing at least two
      const unitItems = Object.entries(units).slice(0, 3);
      if (unitItems.length > 0) {
        unitStatsContainer.innerHTML = '';
        unitItems.forEach(([name, data]) => {
          const percent = Math.min(100, Math.round(Math.random() * 40 + 60)); // Simulate for UI consistency with image
          unitStatsContainer.innerHTML += `
                  <div class="unit-stat-item mt-3">
                    <div class="unit-info">
                      <span>${name}</span>
                      <span>${percent}%</span>
                    </div>
                    <div class="progress-bar">
                      <div class="progress-fill ${percent > 80 ? 'blue' : ''}" style="width: ${percent}%;"></div>
                    </div>
                  </div>
                `;
        });
      }
          }

      // Re-initialize Lucide Icons
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }

      // Calculate percentages

      const statTanpaKet = document.getElementById('statTanpaKet');
      if (statTanpaKet) statTanpaKet.textContent = Math.max(0, stats.tidakHadir - stats.cutiPending);

      // Load recent absensi with new format
      // let allAbsensi = await Data.getAbsensiWithPegawai(); // This line is now redundant due to the inserted code

      // Filter by pegawai if needed
      if (user.role === 'pegawai') {
        if (!user.pegawaiId) {
          const employees = await Data.getPegawai();
          const p = employees.find(x => x.user_id == user.id);
          if (p) {
            user.pegawaiId = p.id;
            localStorage.setItem('simpeg_current_user', JSON.stringify(user));
          }
        }
        if (user.pegawaiId) {
          allAbsensi = allAbsensi.filter(a => a.pegawai_id === user.pegawaiId);
        }
      }

      const absensi = allAbsensi
        .sort((a, b) => new Date(b.tanggal + ' ' + b.jam_masuk) - new Date(a.tanggal + ' ' + a.jam_masuk))
        .slice(0, 5);

      const absensiHtml = absensi.length > 0 ? absensi.map(a => {
        const initials = a.pegawai?.nama ? a.pegawai.nama.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : 'NA';
        const avatarDisplay = a.pegawai?.foto ?
          `<img src="${a.pegawai.foto}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` :
          initials;
        const statusClass = a.status === 'tepat_waktu' ? 'status-hadir' : 'status-terlambat';
        const statusText = a.status === 'tepat_waktu' ? 'Hadir' : 'Terlambat';
        return `
          <tr>
            <td><input type="checkbox" class="row-checkbox" value="${a.id}" onclick="updateBulkActionVisibility()"></td>
            <td>
              <div class="employee-cell">
                <div class="employee-avatar">${avatarDisplay}</div>
                <div class="employee-info">
                  <div class="employee-name">${a.pegawai?.nama || '-'}</div>
                  <div class="employee-nip">NIP. ${a.pegawai?.nip || '-'}</div>
                </div>
              </div>
            </td>
            <td>${a.jam_masuk || '-'} WIB</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>
              <span class="location-cell">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                  <circle cx="12" cy="10" r="3" />
                </svg>
                Kantor Pusat
              </span>
            </td>
            <td>
              <button class="action-menu-btn" onclick="showActionMenu(event, ${a.id})">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="1" />
                  <circle cx="12" cy="5" r="1" />
                  <circle cx="12" cy="19" r="1" />
                </svg>
              </button>
            </td>
          </tr>
        `;
      }).join('') : '<tr><td colspan="6" class="text-center text-muted">Belum ada data absensi</td></tr>';

      const recentAbsensiEl = document.getElementById('recentAbsensi');
      if (recentAbsensiEl) {
        recentAbsensiEl.innerHTML = absensiHtml;
      }
      updateBulkActionVisibility();

      // Show different dashboard based on role
      const adminDash = document.getElementById('adminDashboard');
      const pegDash = document.getElementById('pegawaiDashboard');

      if (user.role === 'pegawai') {
        if (adminDash) adminDash.style.display = 'none';
        if (pegDash) pegDash.style.display = 'block';

        await checkTodayAttendance();
      } else {
        if (adminDash) adminDash.style.display = 'block';
        if (pegDash) pegDash.style.display = 'none';

        // Show search for admin/pimpinan
        const headerSearch = document.getElementById('headerSearch');
        if (headerSearch) headerSearch.style.display = '';

        // Initialize components for admin
        try {
          if (typeof Chart !== 'undefined') {
            await initChart();
          }
          renderCalendar();
        } catch (e) {
          console.error('Error initializing admin components:', e);
        }
      }

          // Sidebar toggle handled in app.js listener
        } catch (err) {
        console.error('Error loading dashboard:', err);
      }
      }

      // Initialize attendance chart
      async function initChart() {
        const chartEl = document.getElementById('attendanceChart');
        if (!chartEl) return;
        const ctx = chartEl.getContext('2d');

        // Get weekly data
        const weekData = await getWeeklyAttendanceData();

        if (attendanceChart) {
          attendanceChart.destroy();
        }

        attendanceChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'],
            datasets: [{
              label: 'Kehadiran',
              data: weekData,
              backgroundColor: '#3b82f6',
              borderRadius: 6,
              borderSkipped: false,
              barThickness: 40,
              maxBarThickness: 50
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  color: '#64748b',
                  font: {
                    size: 12
                  }
                }
              },
              y: {
                beginAtZero: true,
                grid: {
                  color: '#e2e8f0'
                },
                ticks: {
                  color: '#64748b',
                  font: {
                    size: 12
                  },
                  stepSize: 20
                }
              }
            }
          }
        });

        // Update date range text
        const today = new Date();
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - today.getDay() + 1);
        const endOfWeek = new Date(startOfWeek);
        endOfWeek.setDate(startOfWeek.getDate() + 6);

        const formatDate = (d) => `${d.getDate()} ${d.toLocaleDateString('id-ID', { month: 'short' })}`;
        const rangeText = document.getElementById('chartDateRange');
        if (rangeText) {
          rangeText.textContent = `Statistik mingguan (${formatDate(startOfWeek)}-${formatDate(endOfWeek)})`;
        }
      }

      // Get weekly attendance data
      async function getWeeklyAttendanceData() {
        // Limit to 50 for status update check
        const absensi = await Data.getAbsensi({ limit: 50 });
        const today = new Date();
        const startOfWeek = new Date(today);
        startOfWeek.setDate(today.getDate() - today.getDay() + 1);

        const weekData = [0, 0, 0, 0, 0, 0, 0];

        absensi.forEach(a => {
          const date = new Date(a.tanggal);
          if (date >= startOfWeek) {
            const dayIndex = (date.getDay() + 6) % 7; // Monday = 0
            weekData[dayIndex]++;
          }
        });

        // Simulate some data if empty
        if (weekData.every(d => d === 0)) {
          return [24, 22, 25, 23, 27, 5, 2];
        }

        return weekData;
      }

      // Render calendar
      function renderCalendar() {
        const calendarTitle = document.getElementById('calendarMonth');
        if (!calendarTitle) return;

        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();

        // Update month title
        const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
          'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        calendarTitle.textContent = `${monthNames[month]} ${year}`;

        // Get first day of month and total days
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const totalDays = lastDay.getDate();

        // Get day of week for first day (0 = Sunday, adjust for Monday start)
        let startDay = firstDay.getDay();
        startDay = startDay === 0 ? 6 : startDay - 1; // Monday = 0

        // Generate calendar HTML
        const today = new Date();
        let html = '';

        // Previous month days
        const prevMonth = new Date(year, month, 0);
        const prevMonthDays = prevMonth.getDate();
        for (let i = startDay - 1; i >= 0; i--) {
          html += `<span class="calendar-day other-month">${prevMonthDays - i}</span>`;
        }

        // Current month days
        for (let d = 1; d <= totalDays; d++) {
          const isToday = d === today.getDate() && month === today.getMonth() && year === today.getFullYear();
          const classes = ['calendar-day'];
          if (isToday) classes.push('today');
          html += `<span class="${classes.join(' ')}">${d}</span>`;
        }

        // Next month days
        const remainingDays = 42 - (startDay + totalDays);
        for (let d = 1; d <= remainingDays; d++) {
          html += `<span class="calendar-day other-month">${d}</span>`;
        }

        const calDays = document.getElementById('calendarDays');
        if (calDays) calDays.innerHTML = html;
      }

      // Calendar navigation
      document.getElementById('prevMonth')?.addEventListener('click', function () {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
        renderCalendar();
      });

      document.getElementById('nextMonth')?.addEventListener('click', function () {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
        renderCalendar();
      });

      // Check today's attendance for pegawai
      async function checkTodayAttendance() {
        const user = Auth.getCurrentUser();
        if (!user.pegawaiId) return;

        const today = getLocalTodayDate();
        // Fetch specific record for today and user
        const attendance = await Data.getAbsensi({
          pegawai_id: user.pegawaiId,
          tanggal: today,
          limit: 1
        });
        const absensi = attendance[0];

        const statusDiv = document.getElementById('attendanceStatus');
        const statusText = document.getElementById('attendanceStatusText');
        const btnCheckIn = document.getElementById('btnCheckIn');
        const btnCheckOut = document.getElementById('btnCheckOut');

        if (absensi) {
          if (statusDiv) statusDiv.classList.remove('d-none');
          if (absensi.jam_keluar) {
            if (statusText) statusText.textContent = `Anda sudah absen hari ini. Masuk: ${absensi.jam_masuk}, Keluar: ${absensi.jam_keluar}`;
            if (btnCheckIn) btnCheckIn.disabled = true;
            if (btnCheckOut) btnCheckOut.disabled = true;
          } else {
            if (statusText) statusText.textContent = `Anda sudah check-in pada ${absensi.jam_masuk}. Jangan lupa check-out!`;
            if (btnCheckIn) btnCheckIn.disabled = true;
            if (btnCheckOut) btnCheckOut.disabled = false;
          }
        } else {
          if (btnCheckIn) btnCheckIn.disabled = false;
          if (btnCheckOut) btnCheckOut.disabled = true;
        }
      }

      // Handle check-in
      document.getElementById('btnCheckIn')?.addEventListener('click', async function () {
        const user = Auth.getCurrentUser();
        if (!user.pegawaiId) {
          App.showToast('Data pegawai tidak ditemukan!', 'danger');
          return;
        }

        showConfirm('Lakukan Absensi Masuk (Datang)?', async () => {
          const isAtLocation = await App.validateLocation();
          if (!isAtLocation) return;

          const now = new Date();
          const jamMasuk = now.toTimeString().slice(0, 5);
          const today = getLocalTodayDate();

          await Data.create('absensi', {
            pegawai_id: user.pegawaiId,
            tanggal: today,
            jam_masuk: jamMasuk,
            jam_keluar: null,
            status: jamMasuk <= '08:00' ? 'tepat_waktu' : 'terlambat',
            keterangan: 'Check-in via Beranda'
          });

          App.showToast('Berhasil Absen Datang!', 'success');
          loadDashboard();
        });
      });

      // Handle check-out
      document.getElementById('btnCheckOut')?.addEventListener('click', async function () {
        const user = Auth.getCurrentUser();
        if (!user.pegawaiId) return;

        showConfirm('Lakukan Absensi Pulang?', async () => {
          const isAtLocation = await App.validateLocation();
          if (!isAtLocation) return;

          const today = getLocalTodayDate();
          const attendance = await Data.getAbsensi({
            pegawai_id: user.pegawaiId,
            tanggal: today,
            limit: 1
          });
          const absensi = attendance[0];

          if (absensi) {
            const jamKeluar = new Date().toTimeString().slice(0, 5);
            await Data.update('absensi', absensi.id, {
              jam_keluar: jamKeluar
            });
            App.showToast('Berhasil Absen Pulang!', 'success');
            loadDashboard();
          }
        });
      });

      // Handle download report
      async function downloadReport() {
        console.log('Running downloadReport');
        const absensi = await Data.getAbsensiWithPegawai({ limit: 20 });
        const today = new Date();
        const month = today.getMonth();
        const year = today.getFullYear();

        // Filter current month
        const monthlyData = absensi.filter(a => {
          const date = new Date(a.tanggal);
          return date.getMonth() === month && date.getFullYear() === year;
        });

        // Create CSV content
        let csv = 'No,Nama,NIP,Tanggal,Jam Masuk,Jam Keluar,Status\n';
        monthlyData.forEach((a, i) => {
          const status = a.status === 'tepat_waktu' ? 'Hadir' : 'Terlambat';
          csv += `${i + 1},"${a.pegawai?.nama || '-'}","${a.pegawai?.nip || '-'}",${a.tanggal},${a.jam_masuk},${a.jam_keluar || '-'},${status}\n`;
        });

        // Download file
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `Laporan_Absensi_${year}_${String(month + 1).padStart(2, '0')}.csv`;
        link.click();

        App.showToast('Laporan berhasil diunduh!', 'success');
      }

      // Open manual attendance modal
      async function openManualAttendanceModal() {
        console.log('Running openManualAttendanceModal');

        // Reset form and title
        const form = document.getElementById('manualAttendanceForm');
        if (form) form.reset();
        document.getElementById('editAbsensiId').value = '';
        const modalHeader = document.querySelector('#manualAttendanceModal .modal-title');
        if (modalHeader) modalHeader.textContent = 'Absensi Manual';

        // Get pegawai list for dropdown
        const pegawai = (await Data.getPegawai()).filter(p => p.status === 'aktif');
        const select = document.getElementById('manualPegawai');
        if (select) {
          select.innerHTML = '<option value="">Pilih Pegawai</option>' +
            pegawai.map(p => `<option value="${p.id}">${p.nama} (${p.nip})</option>`).join('');
        }

        const today = getLocalTodayDate();
        const now = new Date().toTimeString().slice(0, 5);

        document.getElementById('manualTanggal').value = today;
        document.getElementById('manualJamMasuk').value = now;

        const modal = document.getElementById('manualAttendanceModal');
        if (modal) modal.classList.add('show');
      }

      // Handle manual form submit
      document.getElementById('manualAttendanceForm')?.addEventListener('submit', async function (e) {
        e.preventDefault();
        await submitManualAttendance();
      });

      // Close manual attendance modal
      function closeManualModal() {
        const modal = document.getElementById('manualAttendanceModal');
        if (modal) modal.classList.remove('show');
      }

      // Submit manual attendance
      async function submitManualAttendance() {
        const editId = document.getElementById('editAbsensiId').value;
        const pegawai_id = document.getElementById('manualPegawai').value;
        const tanggal = document.getElementById('manualTanggal').value;
        const jam_masuk = document.getElementById('manualJamMasuk').value;
        const jam_keluar = document.getElementById('manualJamKeluar').value || null;
        const status = document.getElementById('manualStatus').value;
        const keterangan = document.getElementById('manualKeterangan').value || 'Absensi manual';

        if (!pegawai_id || !tanggal || !jam_masuk) {
          App.showToast('Mohon lengkapi data yang diperlukan!', 'warning');
          return;
        }

        if (editId) {
          await Data.update('absensi', parseInt(editId), {
            pegawai_id: parseInt(pegawai_id),
            tanggal: tanggal,
            jam_masuk: jam_masuk,
            jam_keluar: jam_keluar,
            status: status,
            keterangan: keterangan
          });
          App.showToast('Data absensi berhasil diperbarui!', 'success');
          closeManualModal();
          await loadDashboard();
          return;
        }

        // Check if attendance already exists
        const attendance = await Data.getAbsensi({ limit: 50 });
        const existing = attendance.find(a =>
          a.pegawai_id === parseInt(pegawai_id) && a.tanggal === tanggal
        );

        if (existing) {
          showConfirm('Data absensi untuk pegawai ini pada tanggal tersebut sudah ada. Update data?', async () => {
            await Data.update('absensi', existing.id, {
              jam_masuk: jamMasuk,
              jam_keluar: jamKeluar,
              status: status,
              keterangan: keterangan
            });
            App.showToast('Data absensi berhasil diupdate!', 'success');
            closeManualModal();
            await loadDashboard();
          });
          return;
        }

        // Create record
        await Data.create('absensi', {
          pegawai_id: parseInt(pegawai_id),
          tanggal: tanggal,
          jam_masuk: jam_masuk,
          jam_keluar: jam_keluar,
          status: status,
          keterangan: keterangan
        });

        App.showToast('Absensi manual berhasil disimpan!', 'success');
        closeManualModal();
        await loadDashboard();
      }

      // ========= Filter Functionality =========
      function openFilterModal() {
        const modal = document.getElementById('filterModal');
        if (modal) modal.classList.add('show');
      }

      function closeFilterModal() {
        const modal = document.getElementById('filterModal');
        if (modal) modal.classList.remove('show');
      }

      function applyFilter() {
        App.showToast('Filter diterapkan (Simulasi)', 'success');
        closeFilterModal();
        // In real app, re-query data with filters
      }

      // ========= Action Menu Functionality =========
      let currentAbsensiId = null;

      function showActionMenu(event, id) {
        event.preventDefault();
        event.stopPropagation();

        console.log('Action menu clicked for ID:', id);
        currentAbsensiId = id;

        const popover = document.getElementById('actionMenuPopover');

        // Defensive check - if popover doesn't exist, log error and return
        if (!popover) {
          console.error('Action menu popover element not found');
          return;
        }

        const btn = event.currentTarget;
        const rect = btn.getBoundingClientRect();

        // Dynamic positioning for FIXED element
        const popoverWidth = 160;
        let top = rect.bottom + 5;
        let left = rect.left - popoverWidth + rect.width;

        // Boundary check
        if (left < 10) left = 10;

        // Ensure it doesn't go off bottom
        if (top + 100 > window.innerHeight) {
          top = rect.top - 100; // Show above if too low
        }

        popover.style.top = `${top}px`;
        popover.style.left = `${left}px`;
        popover.classList.add('show');

        // Close on click outside
        setTimeout(() => {
          document.addEventListener('click', function closePopover(e) {
            if (!popover.contains(e.target) && e.target !== btn) {
              popover.classList.remove('show');
              document.removeEventListener('click', closePopover);
            }
          });
        }, 100);
      }

      // View Detail Absensi
      async function viewDetailAbsensi() {
        if (!currentAbsensiId) return;

        // Hide popover
        const popover = document.getElementById('actionMenuPopover');
        if (popover) popover.classList.remove('show');

        try {
          const items = await Data.getAbsensiWithPegawai({ id: currentAbsensiId });
          const item = items[0];
          if (!item) return;

          // Populate static fields
          document.getElementById('detNama').textContent = item.pegawai ? item.pegawai.nama : (item.pegawai_id || '-');
          document.getElementById('detTanggal').textContent = new Date(item.tanggal).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
          document.getElementById('detStatus').textContent = item.status.charAt(0).toUpperCase() + item.status.slice(1);
          document.getElementById('detJamMasuk').textContent = item.jam_masuk || '-';
          document.getElementById('detJamKeluar').textContent = item.jam_keluar || '-';
          document.getElementById('detKeterangan').textContent = item.keterangan || '-';

          // Photo handling
          const img = document.getElementById('detFoto');
          if (item.foto_masuk) {
            img.src = item.foto_masuk;
          } else {
            img.src = 'https://placehold.jp/24/f1f5f9/94a3b8/400x300.png?text=Tidak%20Ada%20Foto';
          }

          // Map handling
          const mapSec = document.getElementById('detMapLinkMasuk');
          if (item.lat_masuk && item.lng_masuk) {
            mapSec.innerHTML = `
              <a href="https://www.google.com/maps?q=${item.lat_masuk},${item.lng_masuk}" target="_blank" class="map-link">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                Lihat di Google Maps
              </a>
            `;
            document.getElementById('detLokasiSection').style.display = 'block';
          } else {
            document.getElementById('detLokasiSection').style.display = 'none';
          }

          App.openModal('detailAbsensiModal');
        } catch (error) {
          console.error('Error loading detail:', error);
          App.showToast('Gagal memuat detail absensi', 'danger');
        }
      }

      // Add Manual Absensi
      async function addManualAbsensi() {
        // Reset form
        document.getElementById('manualAttendanceForm').reset();
        document.getElementById('editAbsensiId').value = '';

        // Set default date to today
        document.getElementById('manualTanggal').value = getLocalTodayDate();

        // Get pegawai list for dropdown
        const pegawai = (await Data.getPegawai()).filter(p => p.status === 'aktif');
        const select = document.getElementById('manualPegawai');
        if (select) {
          select.innerHTML = '<option value="">Pilih Pegawai</option>' +
            pegawai.map(p => `<option value="${p.id}">${p.nama} (${p.nip})</option>`).join('');
        }

        const modalHeader = document.querySelector('#manualAttendanceModal .modal-title');
        if (modalHeader) modalHeader.textContent = 'Tambah Absensi Manual';

        App.openModal('manualAttendanceModal');
      }

      async function editAbsensi() {
        if (!currentAbsensiId) return;
        const a = await Data.getById('absensi', currentAbsensiId);
        if (!a) return;

        // Get pegawai list first to ensure dropdown is ready
        const pegawai = (await Data.getPegawai()).filter(p => p.status === 'aktif');
        const select = document.getElementById('manualPegawai');
        if (select) {
          select.innerHTML = '<option value="">Pilih Pegawai</option>' +
            pegawai.map(p => `<option value="${p.id}">${p.nama} (${p.nip})</option>`).join('');
        }

        try {
          document.getElementById('editAbsensiId').value = a.id;
          document.getElementById('manualPegawai').value = a.pegawai_id;
          document.getElementById('manualTanggal').value = a.tanggal;
          document.getElementById('manualJamMasuk').value = a.jam_masuk;
          document.getElementById('manualJamKeluar').value = a.jam_keluar || '';
          document.getElementById('manualStatus').value = a.status;
          document.getElementById('manualKeterangan').value = a.keterangan || '';
        } catch (err) {
          console.error('Error populating form:', err);
          App.showToast('Terjadi kesalahan', 'danger');
          return;
        }

        const modalHeader = document.querySelector('#manualAttendanceModal .modal-title');
        if (modalHeader) modalHeader.textContent = 'Edit Absensi';

        // Hide popover
        const popover = document.getElementById('actionMenuPopover');
        if (popover) popover.classList.remove('show');

        // Open modal
        App.openModal('manualAttendanceModal');
      }

      async function deleteAbsensi() {
        showConfirm('Apakah Anda yakin ingin menghapus data absensi ini?', async () => {
          try {
            await Data.delete('absensi', currentAbsensiId);
            App.showToast('Data absensi berhasil dihapus', 'success');

            if (typeof loadDashboard === 'function') {
              await loadDashboard();
            } else {
              location.reload();
            }
          } catch (error) {
            console.error('Error deleting absensi:', error);
            App.showToast('Gagal menghapus data absensi', 'danger');
          }
        });
      }

      // Save Manual Attendance (Edit/Create)
      async function saveManualAttendance() {
        const id = document.getElementById('editAbsensiId').value;
        const pegawaiId = document.getElementById('manualPegawai').value;
        const tanggal = document.getElementById('manualTanggal').value;
        const jamMasuk = document.getElementById('manualJamMasuk').value;
        const jamKeluar = document.getElementById('manualJamKeluar').value;
        const status = document.getElementById('manualStatus').value;
        const keterangan = document.getElementById('manualKeterangan').value;

        if (!pegawaiId || !tanggal || !jamMasuk) {
          App.showToast('Mohon lengkapi data yang wajib diisi', 'warning');
          return;
        }

        const data = {
          pegawai_id: pegawaiId,
          tanggal,
          jam_masuk: jamMasuk,
          jam_keluar: jamKeluar || null,
          status,
          keterangan: keterangan || null
        };

        try {
          if (id) {
            await Data.update('absensi', id, data);
            App.showToast('Data absensi berhasil diupdate', 'success');
          } else {
            await Data.create('absensi', data);
            App.showToast('Data absensi berhasil ditambahkan', 'success');
          }

          App.closeModal('manualAttendanceModal');

          if (typeof loadDashboard === 'function') {
            await loadDashboard();
          } else {
            location.reload();
          }
        } catch (error) {
          console.error('Error saving attendance:', error);
          App.showToast('Gagal menyimpan data absensi', 'danger');
        }
      }

      // Filter Table by Status (Called by Stat Cards)
      async function filterTableByStatus(status) {
        App.showToast(`Memfilter: ${status === 'all' ? 'Semua Data' : status.toUpperCase()}`, 'info');
        const tbody = document.getElementById('recentAbsensi');
        if (!tbody) return;

        const options = { limit: 100 };
        if (status !== 'all') {
          const filterMap = { 'hadir': 'tepat_waktu', 'terlambat': 'terlambat', 'alpha': 'alpha' };
          options.status = filterMap[status] || status;
        }

        let filtered = await Data.getAbsensiWithPegawai(options);

        tbody.innerHTML = filtered.length > 0 ? filtered.map(a => {
          const initials = a.pegawai?.nama ? a.pegawai.nama.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : 'NA';
          const avatarDisplay = a.pegawai?.foto ? `<img src="${a.pegawai.foto}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">` : initials;
          const statusClass = a.status === 'tepat_waktu' ? 'status-hadir' : (a.status === 'terlambat' ? 'status-terlambat' : 'status-danger');
          const statusLabel = a.status === 'tepat_waktu' ? 'Hadir' : (a.status === 'terlambat' ? 'Terlambat' : a.status.toUpperCase());
          return `
            <tr>
              <td><input type="checkbox" class="row-checkbox" value="${a.id}" onclick="updateBulkActionVisibility()"></td>
              <td><div class="employee-cell"><div class="employee-avatar">${avatarDisplay}</div><div class="employee-info"><div class="employee-name">${a.pegawai?.nama || '-'}</div><div class="employee-nip">NIP. ${a.pegawai?.nip || '-'}</div></div></div></td>
              <td>${a.jam_masuk || '-'} WIB</td>
              <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
              <td><span class="location-cell"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg> Kantor Pusat</span></td>
              <td><button class="action-menu-btn" onclick="showActionMenu(event, ${a.id})"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg></button></td>
            </tr>`;
        }).join('') : '<tr><td colspan="6" class="text-center p-4 text-muted">Tidak ada data untuk filter ini</td></tr>';
      }

      // ========= Selection & Bulk Action Logic =========
      function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.row-checkbox');
        checkboxes.forEach(cb => cb.checked = selectAll.checked);
        updateBulkActionVisibility();
      }

      function updateBulkActionVisibility() {
        const checkboxes = document.querySelectorAll('.row-checkbox');
        const checked = Array.from(checkboxes).filter(cb => cb.checked);
        const bulkActions = document.getElementById('bulkActions');
        const selectAll = document.getElementById('selectAll');

        if (bulkActions) {
          if (checked.length > 0) {
            bulkActions.classList.remove('d-none');
            const selCount = document.getElementById('selectedCount');
            if (selCount) selCount.textContent = checked.length;
          } else {
            bulkActions.classList.add('d-none');
          }
        }

        if (selectAll) {
          selectAll.checked = checkboxes.length > 0 && checked.length === checkboxes.length;
        }
      }

      async function bulkDeleteAbsensi() {
        const checkboxes = document.querySelectorAll('.row-checkbox:checked');
        const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));

        showConfirm(`Apakah Anda yakin ingin menghapus ${ids.length} data absensi yang dipilih?`, async () => {
          for (const id of ids) await Data.delete('absensi', id);

          App.showToast(`${ids.length} data absensi berhasil dihapus`, 'success');
          await loadDashboard();
        });
      }

      // Close action menu when clicking outside
      document.addEventListener('click', function (event) {
        if (!event.target.closest('.action-menu-btn') && !event.target.closest('.action-menu-popover')) {
          document.getElementById('actionMenuPopover')?.classList.remove('show');
        }
      });

      // Initialize
      document.addEventListener('DOMContentLoaded', async () => {
        await App.init();
        await loadDashboard();
      });
      // Confirmation Modal Logic
      let onConfirmCallback = null;
      function showConfirm(message, callback) {
        // Close action menu if open
        const popover = document.getElementById('actionMenuPopover');
        if (popover) popover.classList.remove('show');

        onConfirmCallback = callback;
        const modal = document.getElementById('confirmModal');
        const msgEl = document.getElementById('confirmMessage');
        if (msgEl) msgEl.textContent = message;
        if (modal) modal.classList.add('show');
        document.body.style.overflow = 'hidden';
      }

      function handleConfirm() {
        const modal = document.getElementById('confirmModal');
        if (modal) modal.classList.remove('show');
        document.body.style.overflow = '';
        if (onConfirmCallback) {
          onConfirmCallback();
          onConfirmCallback = null;
        }
      }

      function closeConfirm() {
        const modal = document.getElementById('confirmModal');
        if (modal) modal.classList.remove('show');
        document.body.style.overflow = '';
        onConfirmCallback = null;
      }
    </script>
</body>

</html>