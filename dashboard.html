<!DOCTYPE html>
<html class="light" lang="en">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>Dashboard - SIMPEG PPPK</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,100..900;1,100..900&amp;display=swap"
    rel="stylesheet" />
  <!-- Material Symbols -->
  <link
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
    rel="stylesheet" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <!-- Tailwind Config -->
  <script id="tailwind-config">
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#135bec",
            "background-light": "#f6f6f8",
            "background-dark": "#101622",
          },
          fontFamily: {
            "display": ["Public Sans", "sans-serif"]
          },
          borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
        },
      },
    }
  </script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" async></script>
  <!-- Lucide -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* Calendar Grid Specifics */
    .calendar-day {
      aspect-ratio: 1/1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 9999px;
      cursor: pointer;
      font-size: 0.875rem;
    }

    .calendar-day:hover {
      background-color: #f8fafc;
    }

    .dark .calendar-day:hover {
      background-color: #1e293b;
    }

    .calendar-day.active {
      background-color: #135bec;
      color: white;
    }

    .calendar-day.empty {
      background: transparent;
      cursor: default;
    }
  </style>
</head>

<body
  class="font-display bg-background-light dark:bg-background-dark text-slate-900 dark:text-white h-screen flex overflow-hidden">

  <!-- Sidebar Overlay -->
  <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-20 hidden lg:hidden" onclick="toggleSidebar()"></div>

  <!-- Sidebar -->
  <aside id="sidebar"
    class="w-64 bg-white dark:bg-slate-900 border-r border-slate-200 dark:border-slate-800 flex flex-col flex-shrink-0 transition-all duration-300 z-30 fixed lg:relative h-full -translate-x-full lg:translate-x-0">
    <!-- Logo Area -->
    <a href="dashboard.html"
      class="h-16 flex items-center gap-3 px-6 border-b border-slate-100 dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
      <div class="size-8 rounded-lg bg-primary flex items-center justify-center text-white">
        <span class="material-symbols-outlined text-xl">badge</span>
      </div>
      <div>
        <h1 class="text-base font-bold text-slate-900 dark:text-white leading-none">Absensi</h1>
        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">PPPK Paruh Waktu</p>
      </div>
    </a>
    <!-- Navigation -->
    <div class="flex-1 overflow-y-auto py-4 px-3 flex flex-col gap-1">
      <p class="px-3 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 mt-2">Menu Utama</p>
      <a id="nav-dashboard"
        class="flex items-center gap-3 px-3 py-2.5 rounded-lg bg-primary/10 text-primary group transition-colors"
        href="dashboard.html">
        <span class="material-symbols-outlined text-[20px]">dashboard</span>
        <span class="text-sm font-medium">Dashboard</span>
      </a>

      <div id="group-kepegawaian">
        <p class="px-3 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 mt-6">Kepegawaian</p>
        <a id="nav-pegawai"
          class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 group transition-colors"
          href="pegawai.html">
          <span class="material-symbols-outlined text-[20px]">group</span>
          <span class="text-sm font-medium">Data Pegawai</span>
        </a>
      </div>

      <p class="px-3 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 mt-6">Kehadiran</p>
      <a id="nav-absensi"
        class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 group transition-colors"
        href="absensi.html">
        <span class="material-symbols-outlined text-[20px]">schedule</span>
        <span class="text-sm font-medium">Absensi</span>
      </a>
      <a id="nav-cuti"
        class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 group transition-colors"
        href="cuti.html">
        <span class="material-symbols-outlined text-[20px]">calendar_month</span>
        <span class="text-sm font-medium">Pengajuan Cuti</span>
      </a>

      <p class="px-3 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2 mt-6">Sistem</p>
      <a id="nav-setting"
        class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 group transition-colors"
        href="setting.html">
        <span class="material-symbols-outlined text-[20px]">settings</span>
        <span class="text-sm font-medium">Pengaturan</span>
      </a>
      <a id="nav-profil"
        class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 group transition-colors"
        href="profil.html">
        <span class="material-symbols-outlined text-[20px]">account_circle</span>
        <span class="text-sm font-medium">Profil</span>
      </a>
    </div>
    <!-- User Profile Footer -->
    <div class="p-4 border-t border-slate-100 dark:border-slate-800">
      <div class="flex items-center gap-3">
        <div class="size-10 rounded-full bg-slate-200 dark:bg-slate-700 bg-cover bg-center user-avatar"
          style="background-image: url('https://ui-avatars.com/api/?name=Admin&background=0D8ABC&color=fff');">
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium text-slate-900 dark:text-white truncate user-name">User</p>
          <p class="text-xs text-slate-500 dark:text-slate-400 truncate user-role">Role</p>
        </div>
        <button class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200" onclick="Auth.logout()">
          <span class="material-symbols-outlined text-[20px]">logout</span>
        </button>
      </div>
    </div>
  </aside>

  <!-- ==================== ADMIN DASHBOARD CONTENT ==================== -->
  <main class="flex-1 flex flex-col h-full relative overflow-hidden" id="adminDashboard">
    <!-- Header -->
    <header
      class="h-16 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-6 z-10">
      <div class="flex items-center gap-4">
        <button class="lg:hidden text-slate-500 hover:text-slate-700" onclick="toggleSidebar()">
          <span class="material-symbols-outlined">menu</span>
        </button>
        <h2 class="text-xl font-bold text-slate-800 dark:text-white tracking-tight">Dashboard Admin</h2>
      </div>
      <div class="flex items-center gap-4">
        <div class="hidden md:flex items-center bg-slate-100 dark:bg-slate-800 rounded-lg px-3 py-2 w-64">
          <span class="material-symbols-outlined text-slate-400 text-[20px]">search</span>
          <input
            class="bg-transparent border-none outline-none text-sm ml-2 w-full text-slate-700 dark:text-slate-200 placeholder:text-slate-400 focus:ring-0"
            placeholder="Cari pegawai..." type="text" />
        </div>
        <div class="flex items-center gap-2">
          <!-- Admin Actions -->
        </div>
      </div>
    </header>

    <!-- Scrollable content -->
    <div class="flex-1 overflow-y-auto p-4 md:p-8">
      <div class="max-w-7xl mx-auto space-y-6">
        <!-- Headline -->
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <h3 class="text-2xl font-bold text-slate-900 dark:text-white">Ringkasan Hari Ini</h3>
            <p class="text-slate-500 dark:text-slate-400 text-sm mt-1 currentDateFull">Memuat tanggal...</p>
          </div>
          <div class="flex gap-3">
            <button onclick="addManualAbsensi()"
              class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700 transition-colors shadow-lg shadow-blue-500/30 flex items-center gap-2">
              <span class="material-symbols-outlined text-[18px]">add</span>
              Absensi Manual
            </button>
          </div>
        </div>

        <!-- Global Stats Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <!-- Repeat Card Logic from previous but ensure IDs are unique if needed or accept replace -->
          <!-- ... (Using same IDs as previous file for compatibility) ... -->
          <div
            class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Total Pegawai</p>
                <h4 class="text-2xl font-bold text-slate-900 dark:text-white mt-2" id="statTotalPegawai">0</h4>
              </div>
              <div class="p-2 bg-blue-50 text-blue-600 rounded-lg"><span class="material-symbols-outlined">groups</span>
              </div>
            </div>
          </div>
          <div
            class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Hadir</p>
                <h4 class="text-2xl font-bold text-slate-900 dark:text-white mt-2" id="statHadir">0</h4>
              </div>
              <div class="p-2 bg-emerald-50 text-emerald-600 rounded-lg"><span
                  class="material-symbols-outlined">check_circle</span></div>
            </div>
          </div>
          <div
            class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Terlambat</p>
                <h4 class="text-2xl font-bold text-slate-900 dark:text-white mt-2" id="statTerlambat">0</h4>
              </div>
              <div class="p-2 bg-amber-50 text-amber-600 rounded-lg"><span
                  class="material-symbols-outlined">schedule</span></div>
            </div>
          </div>
          <div
            class="bg-white dark:bg-slate-900 p-5 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm flex flex-col">
            <div class="flex items-start justify-between">
              <div>
                <p class="text-slate-500 dark:text-slate-400 text-sm font-medium">Absen</p>
                <h4 class="text-2xl font-bold text-slate-900 dark:text-white mt-2" id="statAbsen">0</h4>
              </div>
              <div class="p-2 bg-rose-50 text-rose-600 rounded-lg"><span class="material-symbols-outlined">cancel</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div
          class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 shadow-sm overflow-hidden">
          <div class="p-6 border-b border-slate-200 dark:border-slate-800">
            <h3 class="text-lg font-bold">Riwayat Absensi Terkini</h3>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
              <tbody id="recentAbsensi" class="divide-y divide-slate-100"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ==================== PEGAWAI DASHBOARD CONTENT ==================== -->
  <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-slate-50 dark:bg-slate-900" id="pegawaiDashboard"
    style="display: none;">
    <!-- Header Mobile -->
    <header
      class="h-16 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-6 z-10 sticky top-0">
      <div class="flex items-center gap-4">
        <button class="lg:hidden text-slate-500 hover:text-slate-700" onclick="toggleSidebar()">
          <span class="material-symbols-outlined">menu</span>
        </button>
        <div>
          <h2 class="text-lg font-bold text-slate-800 dark:text-white leading-tight">Halo, <span
              class="user-firstName">Pegawai</span></h2>
          <p class="text-xs text-slate-500 dark:text-slate-400 currentDateFull">...</p>
        </div>
      </div>
      <div class="size-8 rounded-full bg-slate-200 bg-cover bg-center user-avatar"></div>
    </header>

    <div class="flex-1 overflow-y-auto p-4 space-y-6">

      <!-- Today's Status Card -->
      <div
        class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-700 p-6 text-center">
        <h3 class="text-sm font-semibold text-slate-500 uppercase tracking-wide mb-4">Absensi Hari Ini</h3>

        <div id="pegawaiStatusContainer" class="mb-6">
          <div class="inline-flex items-center justify-center size-20 rounded-full bg-slate-100 text-slate-400 mb-2">
            <span class="material-symbols-outlined text-[40px]">schedule</span>
          </div>
          <p class="text-lg font-medium text-slate-700 dark:text-slate-300">Belum Check-In</p>
          <p class="text-xs text-slate-500">Silakan lakukan absensi kehadiran</p>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <button id="btnPegawaiCheckIn"
            class="flex flex-col items-center justify-center p-4 rounded-xl bg-primary text-white hover:bg-blue-700 transition-colors shadow-lg shadow-blue-500/20 w-full"
            onclick="handlePegawaiCheckIn()">
            <span class="material-symbols-outlined text-[32px] mb-1">login</span>
            <span class="font-bold">Check In</span>
            <span class="text-[10px] opacity-80" id="lblCheckInTime">--:--</span>
          </button>
          <button id="btnPegawaiCheckOut" disabled
            class="flex flex-col items-center justify-center p-4 rounded-xl bg-slate-100 text-slate-400 w-full cursor-not-allowed"
            onclick="handlePegawaiCheckOut()">
            <span class="material-symbols-outlined text-[32px] mb-1">logout</span>
            <span class="font-bold">Check Out</span>
            <span class="text-[10px] opacity-80" id="lblCheckOutTime">--:--</span>
          </button>
        </div>
      </div>

      <!-- Personal Stats -->
      <div class="grid grid-cols-3 gap-2">
        <div
          class="bg-emerald-50 dark:bg-slate-800 p-3 rounded-xl border border-emerald-100 dark:border-slate-7000 text-center">
          <p class="text-xs text-slate-500 mb-1">Hadir</p>
          <p class="text-xl font-bold text-emerald-600" id="myStatHadir">0</p>
        </div>
        <div
          class="bg-amber-50 dark:bg-slate-800 p-3 rounded-xl border border-amber-100 dark:border-slate-7000 text-center">
          <p class="text-xs text-slate-500 mb-1">Terlambat</p>
          <p class="text-xl font-bold text-amber-600" id="myStatTelat">0</p>
        </div>
        <div
          class="bg-rose-50 dark:bg-slate-800 p-3 rounded-xl border border-rose-100 dark:border-slate-7000 text-center">
          <p class="text-xs text-slate-500 mb-1">Alpha</p>
          <p class="text-xl font-bold text-rose-600" id="myStatAlpha">0</p>
        </div>
      </div>

      <!-- Recent History -->
      <div class="bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 overflow-hidden">
        <div class="px-4 py-3 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
          <h3 class="font-bold text-slate-800 dark:text-white text-sm">Aktivitas Terakhir</h3>
          <a href="absensi.html" class="text-xs text-primary font-medium">Lihat Semua</a>
        </div>
        <div id="myRecentAbsensi" class="divide-y divide-slate-100 dark:divide-slate-700">
          <!-- Populated via JS -->
          <div class="p-4 text-center text-xs text-slate-400">Belum ada aktivitas</div>
        </div>
      </div>

    </div>
  </main>

  <!-- Modals (Manual Attendance for Admin) -->
  <div id="manualAttendanceModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" onclick="closeManualModal()"></div>
    <div class="relative bg-white dark:bg-slate-900 rounded-xl shadow-xl w-full max-w-md p-6">
      <h3 class="text-lg font-bold mb-4">Absensi Manual</h3>
      <form id="manualAttendanceForm" class="space-y-4">
        <input type="hidden" id="editAbsensiId">
        <select id="manualPegawai" class="w-full rounded-lg border-slate-200 text-sm"></select>
        <input type="date" id="manualTanggal" class="w-full rounded-lg border-slate-200 text-sm">
        <div class="grid grid-cols-2 gap-4">
          <input type="time" id="manualJamMasuk" class="w-full rounded-lg border-slate-200 text-sm">
          <input type="time" id="manualJamKeluar" class="w-full rounded-lg border-slate-200 text-sm">
        </div>
        <select id="manualStatus" class="w-full rounded-lg border-slate-200 text-sm">
          <option value="tepat_waktu">Tepat Waktu</option>
          <option value="terlambat">Terlambat</option>
        </select>
      </form>
      <div class="mt-6 flex justify-end gap-2">
        <button onclick="closeManualModal()" class="btn border px-4 py-2 rounded-lg text-sm">Batal</button>
        <button onclick="submitManualAttendance()"
          class="btn bg-primary text-white px-4 py-2 rounded-lg text-sm">Simpan</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-client.js"></script>
  <script src="js/data.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/app.js"></script>

  <script>
    // --- SHARED UI LOGIC ---
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      sidebar.classList.toggle('-translate-x-full');
      overlay.classList.toggle('hidden');
    }

    // --- ADMIN LOGIC ---
    // (Consolidated from previous versions, keeping it functional)
    async function loadAdminDashboard() {
      // Stats
      try {
        const stats = await Data.getStats();
        document.getElementById('statTotalPegawai').textContent = stats.totalPegawai;
        document.getElementById('statHadir').textContent = stats.hadirHariIni;
        document.getElementById('statTerlambat').textContent = stats.terlambatHariIni;
        document.getElementById('statAbsen').textContent = stats.tidakHadir;
      } catch (e) { console.error(e); }

      // Table
      loadRecentAbsensi();
    }

    async function loadRecentAbsensi() {
      // Reuse robust logic 
      // ... (Simplified for brevity, assuming Data.getAbsensiWithPegawai works now)
      const tbody = document.getElementById('recentAbsensi');
      try {
        let absensi = await Data.getAbsensiWithPegawai({ limit: 5 });
        if (!absensi.length) {
          // Fallback attempt
          const abs = await Data.getAbsensi({ limit: 5 });
          const peg = await Data.getPegawai();
          absensi = abs.map(a => ({ ...a, pegawai: peg.find(p => p.id == a.pegawai_id) || {} }));
        }
        tbody.innerHTML = absensi.map(a => `
                <tr class="border-b border-slate-50 hover:bg-slate-50">
                    <td class="px-6 py-4 flex items-center gap-3">
                        <img src="https://ui-avatars.com/api/?name=${a.pegawai?.nama || 'U'}&background=random" class="size-8 rounded-full">
                        <div><p class="font-medium text-slate-900">${a.pegawai?.nama || '-'}</p></div>
                    </td>
                    <td class="px-6 py-4">${a.jam_masuk || '-'}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs bg-slate-100">${a.status}</span></td>
                </tr>
            `).join('');
      } catch (e) { tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-500">Gagal memuat</td></tr>'; }
    }

    // --- PEGAWAI LOGIC ---
    async function loadPegawaiDashboard(user) {
      // 1. Get Pegawai Data
      if (!user.pegawaiId) {
        const employees = await Data.getPegawai();
        const p = employees.find(x => x.user_id == user.id);
        if (p) {
          user.pegawaiId = p.id;
          localStorage.setItem('simpeg_current_user', JSON.stringify(user));
        }
      }

      // 2. Personal Stats
      try {
        const history = await Data.getAbsensi({ pegawai_id: user.pegawaiId, limit: 100 }); // fetch enough for stats
        const today = new Date().toISOString().split('T')[0];
        const currentMonth = today.slice(0, 7);

        const thisMonth = history.filter(h => h.tanggal.startsWith(currentMonth));
        document.getElementById('myStatHadir').textContent = thisMonth.filter(h => h.status === 'hadir' || h.status === 'tepat_waktu').length;
        document.getElementById('myStatTelat').textContent = thisMonth.filter(h => h.status === 'terlambat').length;
        document.getElementById('myStatAlpha').textContent = thisMonth.filter(h => h.status === 'alpha').length;

        // Recent
        const recent = history.slice(0, 5);
        const recContainer = document.getElementById('myRecentAbsensi');
        if (recent.length > 0) {
          recContainer.innerHTML = recent.map(h => `
                     <div class="px-4 py-3 flex items-center justify-between">
                         <div class="flex items-center gap-3">
                             <div class="size-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-500">
                                 <span class="material-symbols-outlined">${h.status === 'tepat_waktu' ? 'check_circle' : 'schedule'}</span>
                             </div>
                             <div>
                                 <p class="text-sm font-medium text-slate-900 dark:text-white">${App.formatDate(h.tanggal)}</p>
                                 <p class="text-xs text-slate-500">${h.jam_masuk || '--:--'} - ${h.jam_keluar || '--:--'}</p>
                             </div>
                         </div>
                         <span class="text-xs font-semibold px-2 py-1 bg-slate-100 rounded">${h.status}</span>
                     </div>
                 `).join('');
        }

        // Check Today
        const todayAbsen = history.find(h => h.tanggal === today);
        const btnCheckIn = document.getElementById('btnPegawaiCheckIn');
        const btnCheckOut = document.getElementById('btnPegawaiCheckOut');
        const statusEl = document.getElementById('pegawaiStatusContainer');

        if (todayAbsen) {
          if (todayAbsen.jam_keluar) {
            statusEl.innerHTML = `<div class="inline-flex items-center justify-center size-20 rounded-full bg-emerald-100 text-emerald-600 mb-2"><span class="material-symbols-outlined text-[40px]">task_alt</span></div><p class="text-lg font-medium text-emerald-600">Selesai Bekerja</p><p class="text-xs text-slate-500">Sampai jumpa besok!</p>`;
            btnCheckIn.disabled = true; btnCheckIn.classList.add('opacity-50', 'cursor-not-allowed');
            btnCheckOut.disabled = true;
          } else {
            statusEl.innerHTML = `<div class="inline-flex items-center justify-center size-20 rounded-full bg-blue-100 text-blue-600 mb-2"><span class="material-symbols-outlined text-[40px]">work</span></div><p class="text-lg font-medium text-blue-600">Sedang Bekerja</p><p class="text-xs text-slate-500">Jangan lupa check-out saat pulang</p>`;
            btnCheckIn.disabled = true; btnCheckIn.classList.add('opacity-50', 'cursor-not-allowed');
            btnCheckOut.disabled = false; btnCheckOut.classList.remove('bg-slate-100', 'text-slate-400', 'cursor-not-allowed');
            btnCheckOut.classList.add('bg-rose-500', 'text-white', 'hover:bg-rose-600', 'shadow-lg', 'shadow-rose-500/20');
          }
          document.getElementById('lblCheckInTime').textContent = todayAbsen.jam_masuk || '--:--';
          document.getElementById('lblCheckOutTime').textContent = todayAbsen.jam_keluar || '--:--';
        }

      } catch (e) { console.error(e); }
    }

    async function handlePegawaiCheckIn() {
      const user = Auth.getCurrentUser();
      if (!user.pegawaiId) return alert('Data pegawai tidak ditemukan');

      // Location
      const isAtLocation = await App.validateLocation();
      if (!isAtLocation) return; // Msg handled in App

      const now = new Date();
      const jam = now.toTimeString().slice(0, 5);
      const status = jam <= '08:00' ? 'tepat_waktu' : 'terlambat';

      try {
        await Data.create('absensi', {
          pegawai_id: user.pegawaiId,
          tanggal: now.toISOString().split('T')[0],
          jam_masuk: jam,
          status: status
        });
        alert('Check In Berhasil!');
        loadPegawaiDashboard(user);
      } catch (e) { alert('Gagal Check In'); }
    }

    async function handlePegawaiCheckOut() {
      const user = Auth.getCurrentUser();
      // Find today's ID
      const today = new Date().toISOString().split('T')[0];
      const history = await Data.getAbsensi({ pegawai_id: user.pegawaiId, tanggal: today });
      if (!history[0]) return;

      try {
        await Data.update('absensi', history[0].id, {
          jam_keluar: new Date().toTimeString().slice(0, 5)
        });
        alert('Check Out Berhasil!');
        loadPegawaiDashboard(user);
      } catch (e) { alert('Gagal Check Out'); }
    }

    // --- MAIN INIT ---
    async function loadDashboard() {
      try {
        const user = Auth.getCurrentUser();
        if (!user) return window.location.href = 'index.html';

        // Common UI updates
        const dateStr = new Date().toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
        document.querySelectorAll('.currentDateFull').forEach(el => el.textContent = dateStr);
        document.querySelectorAll('.user-name').forEach(el => el.textContent = user.name || user.username);
        document.querySelectorAll('.user-role').forEach(el => el.textContent = user.role);
        document.querySelector('.user-firstName').textContent = (user.name || 'User').split(' ')[0];

        // Avatar
        const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || 'U')}&background=0D8ABC&color=fff`;
        document.querySelectorAll('.user-avatar').forEach(el => el.style.backgroundImage = `url('${avatarUrl}')`);

        if (user.role === 'pegawai') {
          // Show Pegawai View
          document.getElementById('adminDashboard').style.display = 'none';
          document.getElementById('pegawaiDashboard').style.display = 'flex';

          // Hide Admin Sidebar Items
          document.getElementById('nav-pegawai').style.display = 'none';
          document.getElementById('nav-setting').style.display = 'none';
          document.getElementById('group-kepegawaian').style.display = 'none';

          // Load Pegawai Data
          await loadPegawaiDashboard(user);
        } else {
          // Show Admin View
          document.getElementById('adminDashboard').style.display = 'flex';
          document.getElementById('pegawaiDashboard').style.display = 'none';
          await loadAdminDashboard();
        }

      } catch (e) { console.error('Init Error', e); }
    }

    // Modal Helpers for Admin (retained for compatibility)
    function closeManualModal() { document.getElementById('manualAttendanceModal').classList.add('hidden'); }
    async function addManualAbsensi() {
      const employees = await Data.getPegawai();
      document.getElementById('manualPegawai').innerHTML = employees.map(p => `<option value="${p.id}">${p.nama}</option>`).join('');
      document.getElementById('manualAttendanceModal').classList.remove('hidden');
    }
  </script>
</body>

</html>