<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Laporan - SIMPEG PPPK">
  <title>Laporan - SIMPEG PPPK</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <link rel="icon" href="img/logo.png" type="image/png">
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
  <div class="app-container">
    <!-- Sidebar Overlay (Mobile) -->
    <div class="sidebar-overlay" onclick="App.closeMobileSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar">
      <!-- Mobile Close Button -->
      <button class="sidebar-close" onclick="App.closeMobileSidebar()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>

      <div class="sidebar-header">
        <div class="sidebar-logo">
          <img src="img/logo.png" alt="Logo">
        </div>
        <div class="sidebar-brand">
          <h1>SIMPEG</h1>
          <span>PPPK Paruh Waktu</span>
        </div>
      </div>
      <nav class="sidebar-nav"></nav>
      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="user-avatar">AD</div>
          <div class="user-info">
            <div class="user-name">Administrator</div>
            <div class="user-role">Admin</div>
          </div>
        </div>
        <button id="logoutBtn" class="btn btn-sm btn-outline mt-3 w-100">Logout</button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header class="top-header">
        <div class="header-left">
          <button class="toggle-sidebar" id="toggleSidebar">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="3" y1="12" x2="21" y2="12" />
              <line x1="3" y1="6" x2="21" y2="6" />
              <line x1="3" y1="18" x2="21" y2="18" />
            </svg>
          </button>
          <div class="page-title">
            <h2>Laporan</h2>
            <p>Generate laporan absensi dan kepegawaian</p>
          </div>
        </div>
      </header>

      <!-- Report Types -->
      <div class="d-grid gap-5" style="grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));">

        <!-- Laporan Absensi -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Laporan Absensi</h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">Periode</label>
              <input type="month" class="form-control" id="absensiMonth">
            </div>
            <div class="form-group">
              <label class="form-label">Pegawai</label>
              <select class="form-control" id="absensiPegawai">
                <option value="">Semua Pegawai</option>
              </select>
            </div>
            <button class="btn btn-primary w-100" onclick="generateAbsensiReport()">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                <polyline points="14 2 14 8 20 8" />
                <line x1="16" y1="13" x2="8" y2="13" />
                <line x1="16" y1="17" x2="8" y2="17" />
                <polyline points="10 9 9 9 8 9" />
              </svg>
              Generate Laporan
            </button>
          </div>
        </div>

        <!-- Laporan Kepegawaian -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Laporan Kepegawaian</h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">Jenis Laporan</label>
              <select class="form-control" id="kepegawaianType">
                <option value="all">Semua Pegawai</option>
                <option value="unit">Per Unit Kerja</option>
                <option value="jabatan">Per Jabatan</option>
              </select>
            </div>
            <div class="form-group" id="unitKerjaFilter">
              <label class="form-label">Unit Kerja</label>
              <select class="form-control" id="kepegawaianUnit">
                <option value="">Semua Unit Kerja</option>
              </select>
            </div>
            <button class="btn btn-primary w-100" onclick="generateKepegawaianReport()">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                <polyline points="14 2 14 8 20 8" />
                <line x1="16" y1="13" x2="8" y2="13" />
                <line x1="16" y1="17" x2="8" y2="17" />
                <polyline points="10 9 9 9 8 9" />
              </svg>
              Generate Laporan
            </button>
          </div>
        </div>

        <!-- Laporan Cuti -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Laporan Cuti</h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">Periode</label>
              <input type="month" class="form-control" id="cutiMonth">
            </div>
            <div class="form-group">
              <label class="form-label">Status</label>
              <select class="form-control" id="cutiStatus">
                <option value="">Semua Status</option>
                <option value="pending">Menunggu</option>
                <option value="approved">Disetujui</option>
                <option value="rejected">Ditolak</option>
              </select>
            </div>
            <button class="btn btn-primary w-100" onclick="generateCutiReport()">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                <polyline points="14 2 14 8 20 8" />
                <line x1="16" y1="13" x2="8" y2="13" />
                <line x1="16" y1="17" x2="8" y2="17" />
                <polyline points="10 9 9 9 8 9" />
              </svg>
              Generate Laporan
            </button>
          </div>
        </div>
        <!-- Laporan Rekapitulasi Kehadiran -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Laporan Rekapitulasi Kehadiran</h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">Periode</label>
              <input type="month" class="form-control" id="rekapMonth">
            </div>
            <button class="btn btn-primary w-100" onclick="generateRekapitulasiReport()">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                <polyline points="14 2 14 8 20 8" />
                <line x1="16" y1="13" x2="8" y2="13" />
                <line x1="16" y1="17" x2="8" y2="17" />
                <polyline points="10 9 9 9 8 9" />
              </svg>
              Generate Laporan Rekapitulasi
            </button>
          </div>
        </div>
      </div>

      <!-- Report Preview -->
      <div class="card mt-5" id="reportPreview" style="display: none;">
        <div class="card-header d-flex justify-between items-center">
          <h3 class="card-title" id="reportTitle">Hasil Laporan</h3>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline btn-excel" onclick="exportToExcel()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                <polyline points="14 2 14 8 20 8" />
                <path d="M8 13h2" />
                <path d="M8 17h2" />
                <path d="M14 13h2" />
                <path d="M14 17h2" />
              </svg>
              Excel
            </button>
            <button class="btn btn-sm btn-outline btn-pdf" onclick="exportToPDF()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" />
                <polyline points="14 2 14 8 20 8" />
                <path d="M9 15h3a2 2 0 0 0 0-4H9v4Z" />
              </svg>
              PDF
            </button>
            <button class="btn btn-sm btn-outline btn-csv" onclick="exportToCSV()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                <polyline points="14 2 14 8 20 8" />
                <line x1="12" y1="18" x2="12" y2="12" />
                <line x1="9" y1="15" x2="15" y2="15" />
              </svg>
              CSV
            </button>
            <button class="btn btn-sm btn-outline btn-print" onclick="printReport()">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 6 2 18 2 18 9" />
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" />
                <rect x="6" y="14" width="12" height="8" />
              </svg>
              Cetak
            </button>
          </div>
        </div>
        <div class="card-body" id="reportContent">
          <!-- Report content will be rendered here -->
        </div>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/supabase-client.js"></script>
  <script src="js/data.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/app.js"></script>
  <!-- Export Libraries -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // Require admin or pimpinan
    if (!Auth.requireRole(['admin', 'pimpinan'])) {
      // Redirected
    }

    // Initialize
    const now = new Date();
    const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

    document.getElementById('absensiMonth').value = currentMonth;
    document.getElementById('cutiMonth').value = currentMonth;
    document.getElementById('rekapMonth').value = currentMonth;

    // Load dropdowns
    async function loadDropdowns() {
      const pegawai = await Data.getPegawai();
      const unitKerja = await Data.getUnitKerja();

      document.getElementById('absensiPegawai').innerHTML = '<option value="">Semua Pegawai</option>' +
        pegawai.map(p => `<option value="${p.id}">${p.nama}</option>`).join('');

      document.getElementById('kepegawaianUnit').innerHTML = '<option value="">Semua Unit Kerja</option>' +
        unitKerja.map(u => `<option value="${u.id}">${u.nama}</option>`).join('');
    }

    // Toggle unit kerja filter based on report type
    document.getElementById('kepegawaianType').addEventListener('change', function () {
      const unitFilter = document.getElementById('unitKerjaFilter');
      unitFilter.style.display = this.value === 'unit' ? 'block' : 'none';
    });

    // Generate Absensi Report
    async function generateAbsensiReport() {
      try {
        const month = document.getElementById('absensiMonth').value;
        const pegawaiId = document.getElementById('absensiPegawai').value;

        if (!month) {
          return App.showToast('Silakan pilih periode bulan', 'warning');
        }

        const opts = { limit: 1000 };
        if (month) opts.month = month;
        if (pegawaiId) opts.pegawai_id = pegawaiId;

        let absensi = await Data.getAbsensiWithPegawai(opts);

        // Apply filters
        if (month) {
          absensi = absensi.filter(a => a.tanggal.startsWith(month));
        }
        if (pegawaiId) {
          absensi = absensi.filter(a => a.pegawai_id == pegawaiId);
        }

        // Get cuti data for the month
        const cutiList = await Data.getAll('cuti');
        const filteredCuti = cutiList.filter(c => {
          if (!c.tanggal_mulai) return false;
          const startMonth = c.tanggal_mulai.substring(0, 7);
          const endMonth = c.tanggal_selesai ? c.tanggal_selesai.substring(0, 7) : startMonth;
          return (startMonth === month || endMonth === month || (startMonth < month && endMonth > month)) && c.status === 'approved';
        });

        // Determine days in month
        const [year, monthNum] = month.split('-').map(Number);
        const daysInMonth = new Date(year, monthNum, 0).getDate();
        const monthName = new Date(year, monthNum - 1, 1).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });

        // Process data: Create a map of attendance by date or group by employee
        let reportData = [];
        const standardKerja = 23; // Standard working days

        if (pegawaiId) {
          // Single employee: Show 1 to daysInMonth
          const attendanceMap = {};
          absensi.forEach(a => {
            attendanceMap[a.tanggal] = a;
          });

          const empCuti = filteredCuti.filter(c => c.pegawai_id == pegawaiId);
          const cutiDates = new Set();
          empCuti.forEach(c => {
            let currentDate = new Date(c.tanggal_mulai);
            const endDate = new Date(c.tanggal_selesai || c.tanggal_mulai);
            while (currentDate <= endDate) {
              const dateStr = currentDate.toISOString().split('T')[0];
              if (dateStr.startsWith(month)) {
                cutiDates.add(dateStr);
              }
              currentDate.setDate(currentDate.getDate() + 1);
            }
          });

          for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${month}-${String(d).padStart(2, '0')}`;
            const attendance = attendanceMap[dateStr];
            const isCuti = cutiDates.has(dateStr);

            reportData.push({
              tanggal: dateStr,
              pegawai: absensi[0]?.pegawai || { nama: document.querySelector('#absensiPegawai option:checked').text },
              jam_masuk: attendance?.jam_masuk || null,
              jam_keluar: attendance?.jam_keluar || null,
              status: attendance?.status || null,
              keterangan: attendance?.keterangan || null,
              empty: !attendance,
              cutiStatus: isCuti ? 'Cuti' : '-',
              terlambatPulang: attendance?.status === 'terlambat' ? 'Terlambat' : (attendance?.jam_keluar ? '-' : '-'),
              standardKerja: standardKerja,
              hariKerja: attendance?.jam_masuk || isCuti ? 1 : 0
            });
          }
        } else {
          // All employees: Show all days for all employees
          const employees = await Data.getPegawai();
          employees.forEach(emp => {
            const empAttendance = absensi.filter(a => a.pegawai_id === emp.id);
            const attendanceMap = {};
            empAttendance.forEach(a => attendanceMap[a.tanggal] = a);

            const empCuti = filteredCuti.filter(c => c.pegawai_id === emp.id);
            const cutiDates = new Set();
            empCuti.forEach(c => {
              let currentDate = new Date(c.tanggal_mulai);
              const endDate = new Date(c.tanggal_selesai || c.tanggal_mulai);
              while (currentDate <= endDate) {
                const dateStr = currentDate.toISOString().split('T')[0];
                if (dateStr.startsWith(month)) {
                  cutiDates.add(dateStr);
                }
                currentDate.setDate(currentDate.getDate() + 1);
              }
            });

            for (let d = 1; d <= daysInMonth; d++) {
              const dateStr = `${month}-${String(d).padStart(2, '0')}`;
              const attendance = attendanceMap[dateStr];
              const isCuti = cutiDates.has(dateStr);

              reportData.push({
                tanggal: dateStr,
                pegawai: emp,
                jam_masuk: attendance?.jam_masuk || null,
                jam_keluar: attendance?.jam_keluar || null,
                status: attendance?.status || null,
                keterangan: attendance?.keterangan || null,
                empty: !attendance,
                cutiStatus: isCuti ? 'Cuti' : '-',
                terlambatPulang: attendance?.status === 'terlambat' ? 'Terlambat' : (attendance?.jam_keluar ? '-' : '-'),
                standardKerja: standardKerja,
                hariKerja: attendance?.jam_masuk || isCuti ? 1 : 0
              });
            }
          });
        }

        // Calculate summary for display (only for actual records)
        const tepatWaktu = absensi.filter(a => a.status === 'tepat_waktu').length;
        const terlambat = absensi.filter(a => a.status === 'terlambat').length;

        const html = `
        <div class="rekap-header" style="text-align: center; margin-bottom: 30px;">
          <h3 style="margin: 0; font-weight: bold; font-size: 16px;">PEMERINTAH KOTA BOGOR</h3>
          <h4 style="margin: 5px 0; font-weight: bold; font-size: 14px; color: #1967d2;">DINAS PEMADAM KEBAKARAN DAN PENYELAMATAN KOTA BOGOR</h4>
          <h4 style="margin: 15px 0 5px; font-weight: bold; font-size: 14px;">LAPORAN DATA ABSENSI</h4>
          <p style="margin: 0; font-size: 12px; color: #666;">Berdasarkan tanggal dan status kehadiran</p>
          <div style="width: 100%; height: 2px; background: #333; margin: 15px 0;"></div>
          <p style="margin: 10px 0; font-weight: bold;">Periode: ${monthName}</p>
        </div>
        <div class="mb-4">
          ${pegawaiId ? `<p>Pegawai: <strong>${document.querySelector('#absensiPegawai option:checked').text}</strong></p>` : ''}
          <div class="d-flex gap-4 mt-3">
            <div class="badge badge-success">Tepat Waktu: ${tepatWaktu}</div>
            <div class="badge badge-warning">Terlambat: ${terlambat}</div>
            <div class="badge badge-primary">Total Kehadiran: ${absensi.length}</div>
          </div>
        </div>
        <div class="table-container" style="overflow-x: auto;">
          <table class="table" style="width: 100%; font-size: 12px; border-collapse: collapse;">
            <thead>
              <tr style="background-color: #f0f0f0;">
                <th style="border: 1px solid #ccc; padding: 8px; text-align: center;">No</th>
                <th style="border: 1px solid #ccc; padding: 8px; text-align: center;">Tanggal</th>
                <th style="border: 1px solid #ccc; padding: 8px; text-align: center;">Pegawai</th>
                <th style="border: 1px solid #ccc; padding: 8px; text-align: center;">Jam Masuk</th>
                <th style="border: 1px solid #ccc; padding: 8px; text-align: center;">Jam Keluar</th>
                <th style="border: 1px solid #ccc; padding: 8px; text-align: center;">Status</th>
                <th style="border: 1px solid #ccc; padding: 8px; text-align: center;">Keterangan</th>
                <th style="border: 1px solid #ccc; padding: 8px; text-align: center;">Cuti</th>
                <th style="border: 1px solid #ccc; padding: 8px; text-align: center;">Terlambat/Pulang</th>
                <th style="border: 1px solid #ccc; padding: 8px; text-align: center;">Standar Kerja</th>
                <th style="border: 1px solid #ccc; padding: 8px; text-align: center;">Hari Kerja</th>
              </tr>
            </thead>
            <tbody>
              ${reportData.length > 0 ? reportData.map((a, i) => `
                <tr ${a.empty ? 'style="color: #999;"' : ''}>
                  <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">${i + 1}</td>
                  <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">${App.formatDate(a.tanggal)}</td>
                  <td style="border: 1px solid #ccc; padding: 6px;">${a.pegawai?.nama || '-'}</td>
                  <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">${a.jam_masuk || '-'}</td>
                  <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">${a.jam_keluar || '-'}</td>
                  <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">${a.empty && !a.cutiStatus.includes('Cuti') ? '<span class="text-muted italic">Tidak Hadir</span>' : (a.status ? App.getStatusBadge(a.status).replace('badge', 'badge-sm') : '-')}</td>
                  <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">${a.keterangan || '-'}</td>
                  <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">${a.cutiStatus}</td>
                  <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">${a.terlambatPulang}</td>
                  <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">${a.standardKerja}</td>
                  <td style="border: 1px solid #ccc; padding: 6px; text-align: center;">${a.hariKerja}</td>
                </tr>
              `).join('') : '<tr><td colspan="11" style="border: 1px solid #ccc; padding: 10px; text-align: center; color: #999;">Tidak ada data</td></tr>'}
            </tbody>
          </table>
        </div>
      `;

        showReport('Laporan Absensi', html);
        App.showToast('Laporan berhasil dibuat', 'success');
      } catch (error) {
        console.error('Error generating absensi report:', error);
        App.showToast('Gagal generate laporan: ' + error.message, 'danger');
      }
    }

    // Generate Kepegawaian Report
    async function generateKepegawaianReport() {
      try {
        const type = document.getElementById('kepegawaianType').value;
        const unitId = document.getElementById('kepegawaianUnit').value;

        let pegawai = await Data.getPegawaiWithRelations();

        // Apply filter
        if (type === 'unit' && unitId) {
          pegawai = pegawai.filter(p => p.unit_kerja_id == unitId);
        }

        // Group by if needed
        let html = '';

        if (type === 'unit') {
          const grouped = {};
          pegawai.forEach(p => {
            const key = p.unit_kerja?.nama || 'Tidak Ada Unit';
            if (!grouped[key]) grouped[key] = [];
            grouped[key].push(p);
          });

          html = Object.entries(grouped).map(([unit, list]) => `
          <div class="mb-4">
            <h4>${unit} (${list.length} pegawai)</h4>
            ${generatePegawaiTable(list)}
          </div>
        `).join('<hr class="my-4">');
        } else if (type === 'jabatan') {
          const grouped = {};
          pegawai.forEach(p => {
            const key = p.jabatan?.nama || 'Tidak Ada Jabatan';
            if (!grouped[key]) grouped[key] = [];
            grouped[key].push(p);
          });

          html = Object.entries(grouped).map(([jabatan, list]) => `
          <div class="mb-4">
            <h4>${jabatan} (${list.length} pegawai)</h4>
            ${generatePegawaiTable(list)}
          </div>
        `).join('<hr class="my-4">');
        } else {
          html = `
          <div class="mb-4">
            <h4>Daftar Semua Pegawai (${pegawai.length} pegawai)</h4>
            ${generatePegawaiTable(pegawai)}
          </div>
        `;
        }

        showReport('Laporan Kepegawaian', html);
      } catch (error) {
        console.error('Error generating kepegawaian report:', error);
        App.showToast('Gagal generate laporan: ' + error.message, 'danger');
      }
    }

    // Helper to generate pegawai table
    function generatePegawaiTable(list) {
      return `
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>No</th>
                <th>NIP</th>
                <th>Nama</th>
                <th>Jabatan</th>
                <th>Unit Kerja</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${list.length > 0 ? list.map((p, i) => `
                <tr>
                  <td>${i + 1}</td>
                  <td>${p.nip}</td>
                  <td>${p.nama}</td>
                  <td>${p.jabatan?.nama || '-'}</td>
                  <td>${p.unit_kerja?.nama || '-'}</td>
                  <td>${App.getStatusBadge(p.status)}</td>
                </tr>
              `).join('') : '<tr><td colspan="6" class="text-center text-muted">Tidak ada data</td></tr>'}
            </tbody>
          </table>
        </div>
      `;
    }

    // Generate Cuti Report
    async function generateCutiReport() {
      try {
        const month = document.getElementById('cutiMonth').value;
        const status = document.getElementById('cutiStatus').value;

        // Assuming Data.getCutiWithPegawai() is implemented or use generic
        const cutiList = await Data.getAll('cuti'); // Fallback if no specific getter
        // Need to link with pegawai
        const employees = await Data.getPegawai();
        let cuti = cutiList.map(c => ({
          ...c,
          pegawai: employees.find(e => e.id === c.pegawai_id)
        }));

        // Apply filters
        if (month) {
          cuti = cuti.filter(c => (c.tanggal_mulai && c.tanggal_mulai.startsWith(month)) || (c.tanggal_selesai && c.tanggal_selesai.startsWith(month)));
        }
        if (status) {
          cuti = cuti.filter(c => c.status === status);
        }

        // Sort by date
        cuti.sort((a, b) => new Date(a.tanggal_mulai) - new Date(b.tanggal_mulai));

        // Calculate summary
        const pending = cuti.filter(c => c.status === 'pending').length;
        const approved = cuti.filter(c => c.status === 'approved').length;
        const rejected = cuti.filter(c => c.status === 'rejected').length;

        const monthName = month ? new Date(month + '-01').toLocaleDateString('id-ID', { month: 'long', year: 'numeric' }) : 'Semua Periode';

        const html = `
        <div class="mb-4">
          <h4>Laporan Cuti - ${monthName}</h4>
          <div class="d-flex gap-4 mt-3">
            <div class="badge badge-warning">Pending: ${pending}</div>
            <div class="badge badge-success">Disetujui: ${approved}</div>
            <div class="badge badge-danger">Ditolak: ${rejected}</div>
          </div>
        </div>
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>No</th>
                <th>Pegawai</th>
                <th>Jenis Cuti</th>
                <th>Tanggal</th>
                <th>Hari</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${cuti.length > 0 ? cuti.map((c, i) => `
                <tr>
                  <td>${i + 1}</td>
                  <td>${c.pegawai?.nama || '-'}</td>
                  <td>${c.jenis_cuti || '-'}</td>
                  <td>${App.formatDate(c.tanggal_mulai)} - ${App.formatDate(c.tanggal_selesai)}</td>
                  <td>${c.jumlah_hari || '-'}</td>
                  <td>${App.getStatusBadge(c.status)}</td>
                </tr>
              `).join('') : '<tr><td colspan="6" class="text-center text-muted">Tidak ada data</td></tr>'}
            </tbody>
          </table>
        </div>
      `;

        showReport('Laporan Cuti', html);
      } catch (error) {
        console.error('Error generating cuti report:', error);
        App.showToast('Gagal generate laporan: ' + error.message, 'danger');
      }
    }

    // Generate Rekapitulasi Kehadiran Report
    async function generateRekapitulasiReport() {
      try {
        const month = document.getElementById('rekapMonth').value;

        if (!month) {
          return App.showToast('Silakan pilih periode bulan', 'warning');
        }

        // Get all employees and attendance data
        const pegawai = await Data.getPegawai();
        const [year, monthNum] = month.split('-').map(Number);
        const daysInMonth = new Date(year, monthNum, 0).getDate();
        const monthName = new Date(year, monthNum - 1, 1).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });

        // Get all attendance records for the month
        const absensi = await Data.getAbsensiWithPegawai({ limit: 10000 });
        const filteredAbsensi = absensi.filter(a => a.tanggal && a.tanggal.startsWith(month));

        // Get cuti data for the month
        const cutiList = await Data.getAll('cuti');
        const filteredCuti = cutiList.filter(c => {
          if (!c.tanggal_mulai) return false;
          const startMonth = c.tanggal_mulai.substring(0, 7);
          const endMonth = c.tanggal_selesai ? c.tanggal_selesai.substring(0, 7) : startMonth;
          return startMonth === month || endMonth === month || (startMonth < month && endMonth > month);
        });

        // Calculate statistics for each employee
        const rekapData = pegawai.map((emp, index) => {
          const empAbsensi = filteredAbsensi.filter(a => a.pegawai_id === emp.id);
          const empCuti = filteredCuti.filter(c => c.pegawai_id === emp.id && c.status === 'approved');

          // Count attendance by status
          const hadir = empAbsensi.filter(a => a.jam_masuk).length;
          const terlambat = empAbsensi.filter(a => a.status === 'terlambat').length;

          // Count leave types
          let cutiCount = 0;
          let sakitCount = 0;
          empCuti.forEach(c => {
            const days = c.jumlah_hari || 1;
            if (c.jenis_cuti?.toLowerCase().includes('sakit')) {
              sakitCount += days;
            } else {
              cutiCount += days;
            }
          });

          // Calculate first and last attendance for Kalkula Hadir
          const sortedAbsensi = [...empAbsensi].sort((a, b) => a.tanggal.localeCompare(b.tanggal));
          const firstAttendance = sortedAbsensi[0];
          const lastAttendance = sortedAbsensi[sortedAbsensi.length - 1];

          let kalkulaHadir = '';
          if (firstAttendance && lastAttendance) {
            if (firstAttendance.id === lastAttendance.id) {
              kalkulaHadir = `${firstAttendance.tanggal.substring(8, 10)}-${firstAttendance.jam_masuk?.substring(0, 5) || ''}`;
            } else {
              kalkulaHadir = `${firstAttendance.tanggal.substring(8, 10)}-${firstAttendance.jam_masuk?.substring(0, 5) || ''} s/d ${lastAttendance.tanggal.substring(8, 10)}-${lastAttendance.jam_keluar?.substring(0, 5) || ''}`;
            }
          }

          // Calculate totals
          const totalTMK = parseFloat((terlambat / (hadir || 1)).toFixed(2));
          const standardKerja = 23; // Standard working days
          const hariKerja = hadir + cutiCount + sakitCount;

          return {
            no: index + 1,
            nama: emp.nama,
            nip: emp.nip,
            hadir: hadir,
            terlambat: terlambat,
            cuti: cutiCount + sakitCount, // Combined since sakit column is not in image
            hariKerja: hadir + cutiCount + sakitCount
          };
        });

        // Generate HTML with simplified header matching Excel image
        const html = `
        <div class="rekap-header" style="margin-bottom: 20px; font-family: Arial, sans-serif;">
          <div style="font-weight: bold; font-size: 14px;">Dinas Pemadam Kebakaran dan Penyelamatan Kota Bogor</div>
          <div style="font-weight: bold; font-size: 14px;">Laporan Rekapitulasi Kehadiran</div>
          <div style="font-weight: bold; font-size: 14px;">Periode ${monthName}</div>
        </div>
        <div class="table-container" style="overflow-x: auto;">
          <table class="table rekap-table" style="width: 100%; border-collapse: collapse; font-family: Arial, sans-serif;">
            <thead>
              <tr style="border-bottom: 1px solid #000;">
                <th style="padding: 5px; text-align: left; border: 1px solid #ccc;">no</th>
                <th style="padding: 5px; text-align: left; border: 1px solid #ccc;">nama</th>
                <th style="padding: 5px; text-align: left; border: 1px solid #ccc;">hadir</th>
                <th style="padding: 5px; text-align: left; border: 1px solid #ccc;">terlambat</th>
                <th style="padding: 5px; text-align: left; border: 1px solid #ccc;">cuti</th>
                <th style="padding: 5px; text-align: left; border: 1px solid #ccc;">Hari Kerja</th>
              </tr>
            </thead>
            <tbody>
              ${rekapData.map(row => `
                <tr>
                  <td style="padding: 5px; border: 1px solid #ccc;">${row.no}</td>
                  <td style="padding: 5px; border: 1px solid #ccc;">
                    ${row.nama}<br>
                    <span style="font-size: 11px;">${row.nip}</span>
                  </td>
                  <td style="padding: 5px; border: 1px solid #ccc;">${row.hadir}</td>
                  <td style="padding: 5px; border: 1px solid #ccc;">${row.terlambat}</td>
                  <td style="padding: 5px; border: 1px solid #ccc;">${row.cuti}</td>
                  <td style="padding: 5px; border: 1px solid #ccc;">${row.hariKerja}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

        showReport('Laporan Rekapitulasi Kehadiran', html);

        // Store the recap data for export
        window.currentRekapData = rekapData;
        window.currentRekapPeriod = monthName;

        App.showToast('Laporan berhasil dibuat', 'success');
      } catch (error) {
        console.error('Error generating rekapitulasi report:', error);
        App.showToast('Gagal generate laporan: ' + error.message, 'danger');
      }
    }

    // Show report
    function showReport(title, content) {
      document.getElementById('reportTitle').textContent = title;
      document.getElementById('reportContent').innerHTML = content;
      document.getElementById('reportPreview').style.display = 'block';
      document.getElementById('reportPreview').scrollIntoView({ behavior: 'smooth' });
    }

    // Print report
    function printReport() {
      const content = document.getElementById('reportContent').innerHTML;
      const title = document.getElementById('reportTitle').textContent;

      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>${title} - SIMPEG PPPK</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 40px; color: #333; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
            th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
            th { background-color: #f9f9f9; font-weight: bold; }
            h2 { margin-bottom: 5px; color: #135bec; }
            h3 { margin-bottom: 20px; font-weight: normal; color: #666; }
            h4 { margin-top: 0; margin-bottom: 15px; }
            .badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 11px; margin-right: 10px; font-weight: bold; }
            .badge-success { background: #e6f4ea; color: #1e8e3e; }
            .badge-warning { background: #fef7e0; color: #d93025; }
            .badge-danger { background: #fce8e6; color: #d93025; }
            .badge-primary { background: #e8f0fe; color: #1967d2; }
            .mb-4 { margin-bottom: 30px; }
            .d-flex { display: flex; }
            .gap-4 { gap: 20px; }
            .mt-3 { margin-top: 15px; }
            hr { border: 0; border-top: 1px solid #eee; margin: 30px 0; }
            @media print { 
              body { padding: 0; }
              .no-print { display: none; }
            }
          </style>
        </head>
        <body>
          <div style="text-align: center; margin-bottom: 40px;">
            <h2 style="margin: 0;">PEMERINTAH KOTA BOGOR</h2>
            <h3 style="margin: 5px 0 0 0;">DINAS PEMADAM KEBAKARAN DAN PENYELAMATAN</h3>
            <p style="font-size: 12px; color: #888; margin: 5px 0;">Jl. Raya Pajajaran No. 1, Kota Bogor</p>
          </div>
          <hr>
          <h3 style="text-align: center; font-weight: bold; color: #333; margin-top: 20px;">${title.toUpperCase()}</h3>
          <p style="font-size: 11px; text-align: right; color: #777;">Dicetak pada: ${new Date().toLocaleDateString('id-ID', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      })}</p>
          ${content}
          <div style="margin-top: 60px; display: flex; justify-content: flex-end;">
            <div style="text-align: center; width: 250px;">
              <p>Bogor, ${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
              <p style="margin-bottom: 80px;">Mengetahui, Kepala Dinas</p>
              <p style="font-weight: bold; text-decoration: underline;">--------------------------</p>
              <p>NIP. -</p>
            </div>
          </div>
        </body>
        </html>
      `);
      printWindow.document.close();
      setTimeout(() => {
        printWindow.print();
      }, 500);
    }


    // Export to Excel
    function exportToExcel() {
      const title = document.getElementById('reportTitle').textContent;

      // Check if this is a rekapitulasi report
      if (window.currentRekapData && window.currentRekapPeriod) {
        const wb = XLSX.utils.book_new();

        // Create header rows matching the requested image header
        const headerRows = [
          ['Dinas Pemadam Kebakaran dan Penyelamatan Kota Bogor'],
          ['Laporan Rekapitulasi Kehadiran'],
          [`Periode ${window.currentRekapPeriod}`],
          [''],
          // Main headers
          ['no', 'nama', 'hadir', 'terlambat', 'cuti', 'Hari Kerja']
        ];

        // Add data rows - matching simplified structure
        const dataRows = window.currentRekapData.map(row => [
          row.no,
          `${row.nama}\n${row.nip}`,
          row.hadir,
          row.terlambat,
          row.cuti,
          row.hariKerja
        ]);

        const allRows = [...headerRows, ...dataRows];
        const ws = XLSX.utils.aoa_to_sheet(allRows);

        // Set column widths
        ws['!cols'] = [
          { wch: 5 },  // no
          { wch: 35 }, // nama
          { wch: 10 }, // hadir
          { wch: 10 }, // terlambat
          { wch: 10 }, // cuti
          { wch: 12 }  // Hari Kerja
        ];

        // Add some basic styling for cell wrapping on nama column if possible (AOA to sheet doesn't always handle newlines well without alignment)
        // Note: Basic XLSX library has limited styling without the Pro version, but we can try to set the property
        dataRows.forEach((_, i) => {
          const cellPos = XLSX.utils.encode_cell({ c: 1, r: i + 5 });
          if (ws[cellPos]) ws[cellPos].s = { alignment: { wrapText: true, vertical: 'top' } };
        });

        XLSX.utils.book_append_sheet(wb, ws, "Rekapitulasi");
        XLSX.writeFile(wb, `Laporan_Rekapitulasi_Kehadiran_${window.currentRekapPeriod.replace(/\s/g, '_')}.xlsx`);
      } else {
        // Fallback to table export for other reports
        const table = document.querySelector('#reportContent table');
        if (!table) return alert('Tidak ada data untuk diekspor');

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.table_to_sheet(table);

        XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
        XLSX.writeFile(wb, `${title}_${new Date().getTime()}.xlsx`);
      }
    }

    // Export to CSV
    function exportToCSV() {
      const table = document.querySelector('#reportContent table');
      if (!table) return alert('Tidak ada data untuk diekspor');

      const title = document.getElementById('reportTitle').textContent;
      const ws = XLSX.utils.table_to_sheet(table);
      const csv = XLSX.utils.sheet_to_csv(ws);

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", `${title}_${new Date().getTime()}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Export to PDF
    async function exportToPDF() {
      const element = document.getElementById('reportContent');
      if (!element) return alert('Tidak ada data untuk diekspor');

      const title = document.getElementById('reportTitle').textContent;
      const { jsPDF } = window.jspdf;

      try {
        // Use landscape for recap reports due to many columns
        const isRekap = window.currentRekapData && window.currentRekapPeriod;
        const orientation = isRekap ? 'l' : 'p'; // landscape or portrait

        const canvas = await html2canvas(element, {
          scale: 2,
          logging: false,
          useCORS: true
        });

        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF(orientation, 'mm', 'a4');
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

        // Use descriptive filename for recap reports
        const filename = isRekap
          ? `Laporan_Rekapitulasi_Kehadiran_${window.currentRekapPeriod.replace(/\s/g, '_')}.pdf`
          : `${title}_${new Date().getTime()}.pdf`;

        pdf.save(filename);
      } catch (error) {
        console.error('PDF Export Error:', error);
        alert('Gagal mengekspor PDF');
      }
    }

    (async () => {
      await loadDropdowns();
    })();
  </script>
</body>

</html>