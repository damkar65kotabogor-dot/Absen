<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insert Pegawai Data (Versi Stabil)</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
            background: #f9f9f9;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin-top: 0;
            color: #333;
        }

        #log {
            margin-top: 20px;
            background: #1e293b;
            color: #4ade80;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .progress-bar {
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #2563eb;
            width: 0%;
            transition: width 0.3s;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-weight: bold;
        }

        .stat-item {
            padding: 10px;
            background: #f1f5f9;
            border-radius: 4px;
            flex: 1;
            text-align: center;
        }

        .success {
            color: #16a34a;
        }

        .error {
            color: #dc2626;
        }
    </style>
</head>

<body>
    <div class="card">
        <h1>üöÄ Insert Data Pegawai (Manual)</h1>

        <div style="text-align: center; margin: 20px 0;">
            <!-- Tombol LANGSUNG DITAMPILKAN tanpa display:none -->
            <button id="manualBtn" onclick="runScript()"
                style="padding: 15px 30px; background: #2563eb; color: white; border:none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold;">
                ‚ñ∂Ô∏è KLIK TOMBOL INI UNTUK MULAI
            </button>
        </div>

        <div class="stats">
            <div class="stat-item">Total Data: <span id="totalCount">27</span></div>
            <div class="stat-item success">Berhasil: <span id="successCount">0</span></div>
            <div class="stat-item error">Gagal: <span id="failCount">0</span></div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div id="status" style="margin-bottom: 10px; font-weight: bold;">Menunggu perintah...</div>
        <div id="log">Log system ready...</div>
    </div>

    <!-- Script Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        const SUPABASE_URL = 'https://nkkszblyffksojkizomh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ra3N6Ymx5ZmZrc29qa2l6b21oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyOTgwMDUsImV4cCI6MjA4Mjg3NDAwNX0.qfHVnczBIIvRELkykBWHFlpVpvm6e7EhXDDzp4zMRu0';

        // Data provided by user
        const rawData = [
            ['199804162025211000', 'Adi Tya Kusuma', 'adi.tya@dpkp.bogor.go.id', '081234567001', 'Bogor', '1998-04-16', 'L', '2025-01-01', 'aktif'],
            ['197502102025211030', 'Agus Suhaeri', 'agus.suhaeri@dpkp.bogor.go.id', '081234567002', 'Bogor', '1975-02-10', 'L', '2025-01-01', 'aktif'],
            ['199709242025211061', 'Akbar Solihin Zulkifli', 'akbar.solihin@dpkp.bogor.go.id', '081234567003', 'Bogor', '1997-09-24', 'L', '2025-01-01', 'aktif'],
            ['199905182025211036', 'Asep Saepul Anwar', 'asep.saepul@dpkp.bogor.go.id', '081234567004', 'Bogor', '1999-05-18', 'L', '2025-01-01', 'aktif'],
            ['199703202025211056', 'Chaeril Hari Mugeni', 'chaeril.hari@dpkp.bogor.go.id', '081234567005', 'Bogor', '1997-03-20', 'L', '2025-01-01', 'aktif'],
            ['199911262025211039', 'Deni Bachtiar', 'deni.bachtiar@dpkp.bogor.go.id', '081234567006', 'Bogor', '1999-11-26', 'L', '2025-01-01', 'aktif'],
            ['199609212025211070', 'Doni Safutra', 'doni.safutra@dpkp.bogor.go.id', '081234567007', 'Bogor', '1996-09-21', 'L', '2025-01-01', 'aktif'],
            ['199808232025211048', 'Erdinda Sukmadinata', 'erdinda.sukmadinata@dpkp.bogor.go.id', '081234567008', 'Bogor', '1998-08-23', 'L', '2025-01-01', 'aktif'],
            ['199705212025211051', 'Fajar Triadi', 'fajar.triadi@dpkp.bogor.go.id', '081234567009', 'Bogor', '1997-05-21', 'L', '2025-01-01', 'aktif'],
            ['199403092025211074', 'Fauzi Ramadan', 'fauzi.ramadan@dpkp.bogor.go.id', '081234567010', 'Bogor', '1994-03-09', 'L', '2025-01-01', 'aktif'],
            ['198807052025211119', 'Juliyana Mulyadani', 'juliyana.mulyadani@dpkp.bogor.go.id', '081234567011', 'Bogor', '1988-07-05', 'P', '2025-01-01', 'aktif'],
            ['200001012025211065', 'Nahdi Ramhan', 'nahdi.ramhan@dpkp.bogor.go.id', '081234567012', 'Bogor', '2000-01-01', 'L', '2025-01-01', 'aktif'],
            ['199401112025211066', 'Nandar Sukmana', 'nandar.sukmana@dpkp.bogor.go.id', '081234567013', 'Bogor', '1994-01-11', 'L', '2025-01-01', 'aktif'],
            ['199511032025211069', 'Novaldi Setiawan', 'novaldi.setiawan@dpkp.bogor.go.id', '081234567014', 'Bogor', '1995-11-03', 'L', '2025-01-01', 'aktif'],
            ['199811162025212048', 'Raden Yunita', 'raden.yunita@dpkp.bogor.go.id', '081234567015', 'Bogor', '1998-11-16', 'P', '2025-01-01', 'aktif'],
            ['199801012025211072', 'Rizky Ramandani', 'rizky.ramandani@dpkp.bogor.go.id', '081234567016', 'Bogor', '1998-01-01', 'L', '2025-01-01', 'aktif'],
            ['200001102025211041', 'Sendy Dwi Pangga', 'sendy.dwi@dpkp.bogor.go.id', '081234567017', 'Bogor', '2000-01-10', 'L', '2025-01-01', 'aktif'],
            ['199510252025211082', 'Seno Albianto', 'seno.albianto@dpkp.bogor.go.id', '081234567018', 'Bogor', '1995-10-25', 'L', '2025-01-01', 'aktif'],
            ['199406192025212073', 'Sri Handayani', 'sri.handayani@dpkp.bogor.go.id', '081234567019', 'Bogor', '1994-06-19', 'P', '2025-01-01', 'aktif'],
            ['199412302025211074', 'Sugianto', 'sugianto@dpkp.bogor.go.id', '081234567020', 'Bogor', '1994-12-30', 'L', '2025-01-01', 'aktif'],
            ['199610222025211050', 'Teguh Nurhakim', 'teguh.nurhakim@dpkp.bogor.go.id', '081234567021', 'Bogor', '1996-10-22', 'L', '2025-01-01', 'aktif'],
            ['199902042025211036', 'Vareski Nalfaredo', 'vareski.nalfaredo@dpkp.bogor.go.id', '081234567022', 'Bogor', '1999-02-04', 'L', '2025-01-01', 'aktif'],
            ['199701052025212061', 'Vivi Hastuti', 'vivi.hastuti@dpkp.bogor.go.id', '081234567023', 'Bogor', '1997-01-05', 'P', '2025-01-01', 'aktif'],
            ['199706182025211052', 'Zico Arya Pratama', 'zico.arya@dpkp.bogor.go.id', '081234567024', 'Bogor', '1997-06-18', 'L', '2025-01-01', 'aktif'],
            ['197812202025211041', 'Wellem Aufa', 'wellem.aufa@dpkp.bogor.go.id', '081234567025', 'Bogor', '1978-12-20', 'L', '2025-01-01', 'aktif'],
            ['198008092025211055', 'David Indra', 'david.indra@dpkp.bogor.go.id', '081234567026', 'Bogor', '1980-08-09', 'L', '2025-01-01', 'aktif'],
            ['199303242025211140', 'Rm.Rangga Putra', 'rangga.putra@dpkp.bogor.go.id', '081234567027', 'Bogor', '1993-03-24', 'L', '2025-01-01', 'aktif']
        ];

        function log(msg) {
            const div = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            div.textContent += `[${time}] ${msg}\n`;
            div.scrollTop = div.scrollHeight;
        }

        async function runScript() {
            const btn = document.getElementById('manualBtn');
            const status = document.getElementById('status');

            btn.disabled = true;
            btn.textContent = "‚è≥ SEDANG MEMPROSES...";
            status.textContent = "Menginisialisasi koneksi...";

            try {
                if (typeof window.supabase === 'undefined') {
                    throw new Error("Library Supabase belum termuat. Mohon refresh halaman.");
                }

                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                status.textContent = "‚úÖ Koneksi OK. Memulai insert...";
                log("Mulai sync data...");

                // 1. Fetch Users
                const { data: users, error: userError } = await supabase.from('users').select('id, username');
                if (userError) throw userError;

                const userMap = {};
                users.forEach(u => userMap[u.username] = u.id);
                log(`Database user loaded: ${users.length} items.`);

                // 2. Loop
                let success = 0;
                let fail = 0;

                for (let i = 0; i < rawData.length; i++) {
                    const row = rawData[i];
                    const nip = row[0];
                    const userId = userMap[nip];

                    // UI Bar
                    const pct = Math.round(((i + 1) / rawData.length) * 100);
                    document.getElementById('progressFill').style.width = `${pct}%`;

                    if (!userId) {
                        log(`SKIP: User ${nip} tidak ditemukan.`);
                        fail++;
                        continue;
                    }

                    const pegawaiData = {
                        nip: row[0], nama: row[1], email: row[2],
                        telepon: row[3], alamat: row[4], tanggal_lahir: row[5],
                        jenis_kelamin: row[6], tanggal_masuk: row[7],
                        status: row[8], user_id: userId
                    };

                    // Upsert logic
                    const { data: existing } = await supabase.from('pegawai').select('id').eq('nip', nip).maybeSingle();

                    if (existing) {
                        await supabase.from('pegawai').update(pegawaiData).eq('id', existing.id);
                        log(`‚úÖ Updated: ${pegawaiData.nama}`);
                    } else {
                        await supabase.from('pegawai').insert(pegawaiData);
                        log(`‚úÖ Inserted: ${pegawaiData.nama}`);
                    }
                    success++;

                    document.getElementById('successCount').textContent = success;
                    document.getElementById('failCount').textContent = fail;
                }

                status.textContent = "üéâ SELESAI!";
                btn.textContent = "‚úÖ SUKSES";

            } catch (e) {
                log("ERROR: " + e.message);
                status.textContent = "‚ùå ERROR: " + e.message;
                btn.textContent = "‚ö†Ô∏è Gagal - Coba Refresh";
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>